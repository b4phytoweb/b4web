<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Documentazione Tecnica ‚Äî B4PhytoWeb API</title>
    <meta name="description" content="Manuale di installazione e descrizione dei moduli e degli endpoint dell'API backend B4Web.">
    <style>
        :root {
            --color-primary: #007bff;
            --color-secondary: #6c757d;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #17a2b8;
            --color-light: #f8f9fa;
            --color-dark: #343a40;
            --color-text-body: #212529;
            --color-text-muted: #6c757d;
            --font-inter: 'Inter', sans-serif;
            --spacing-unit: 1rem;
        }

        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-inter);
            color: var(--color-text-body);
            line-height: 1.6;
            background-color: #ffffff;
            scroll-behavior: smooth;
        }

        a {
            color: var(--color-primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .wrap, .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-unit) * 2;
        }

        .section {
            padding: var(--spacing-unit) * 4 0;
        }

        /* Header/Nav */
        .nav {
            border-bottom: 1px solid var(--color-light);
            background: var(--color-dark);
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-unit) 2rem;
        }

        .brand {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--color-light);
        }

        .brand img {
            height: 28px;
            width: 28px;
            margin-right: 0.5rem;
            /* Placeholder for SVG styling */
            background-color: var(--color-primary);
            border-radius: 4px;
        }

        .navbar nav ul {
            list-style: none;
            display: flex;
            gap: 1.5rem;
        }

        .navbar nav a {
            color: var(--color-light);
            text-decoration: none;
            font-weight: 400;
        }
        
        .navbar nav a:hover {
            color: var(--color-primary);
            text-decoration: none;
        }

        .menu-toggle {
            display: none; /* Hide toggle button on desktop */
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            background-color: #d1e7dd;
            color: #0f5132;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .badge .dot {
            width: 8px;
            height: 8px;
            background-color: #0f5132;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        /* Hero Section (Customized for Documentation) */
        .page-hero {
            background: #e9f0ff; /* Light blue background for hero */
            padding: 4rem 0;
            border-bottom: 1px solid #c2d2ff;
        }
        
        .page-hero .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-unit) 2rem;
        }
        
        .page-hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--color-dark);
        }
        
        .page-hero p {
            font-size: 1.1rem;
            color: var(--color-text-body);
        }

        /* Manual Layout (Sidebar + Content) */
        .manual-layout {
            display: grid;
            grid-template-columns: 250px 1fr; /* 250px for sidebar, rest for content */
            gap: 3rem;
            align-items: start;
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            position: sticky;
            top: 2rem;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 6px;
            background-color: var(--color-light);
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }

        .sidebar-nav ul {
            list-style: none;
        }

        .sidebar-nav > ul > li {
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid #ddd;
        }
        
        .sidebar-nav > ul > li:first-child {
            border-top: none;
            margin-top: 0;
        }

        .sidebar-nav > ul > li > a {
            font-weight: 700;
            display: block;
            padding: 0.25rem 0;
            color: var(--color-dark);
        }

        .sidebar-nav ul ul {
            padding-left: 1rem;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .sidebar-nav ul ul li {
            margin-top: 0.25rem;
        }

        .sidebar-nav ul ul a {
            font-weight: 400;
            color: var(--color-text-body);
            display: block;
        }
        
        /* Main Content */
        .main-content {
            padding: 0 1rem;
        }
        
        .main-content h2 {
            font-size: 2rem;
            margin: 2rem 0 1rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
            color: var(--color-primary);
        }
        
        .main-content h3 {
            font-size: 1.5rem;
            margin: 1.5rem 0 0.75rem;
            color: var(--color-dark);
        }
        
        .main-content h4 {
            font-size: 1.25rem;
            margin: 1rem 0 0.5rem;
            color: var(--color-text-body);
        }

        .main-content pre {
            background: #282c34;
            color: #abb2bf;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .main-content ul, .main-content ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .main-content ul li, .main-content ol li {
            margin-bottom: 0.5rem;
        }

        .main-content p {
            margin-bottom: 1rem;
        }

        .main-content .code-block-title {
            font-weight: 600;
            color: var(--color-primary);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .main-content .warning {
            padding: 1rem;
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            margin: 1rem 0;
            color: #664d03;
        }
        
        /* Footer Styles */
        .footer {
            background: var(--color-dark);
            color: var(--color-light);
            padding: 3rem 0;
            border-top: 5px solid var(--color-primary);
        }

        .footer .cols {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr;
            gap: 2rem;
        }

        .footer .brand {
            color: var(--color-light);
        }

        .footer h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--color-light);
        }

        .footer ul {
            list-style: none;
        }

        .footer ul a {
            color: #bbb;
            display: block;
            padding: 0.25rem 0;
        }

        .footer .muted {
            font-size: 0.85rem;
            color: #aaa;
        }

        .footer-logos img {
            opacity: 0.8;
            max-width: 100px;
            height: auto;
        }
        
        /* Media Queries for Responsiveness (optional but good practice) */
        @media (max-width: 992px) {
            .manual-layout {
                grid-template-columns: 1fr;
            }

            .sidebar-nav {
                position: relative;
                top: auto;
            }
            
            .footer .cols {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
<header class="nav">
    <div class="navbar">
        <a class="brand" href="index.html" aria-label="B4PhytoWeb Home">
            <img src="assets/logo.svg" alt="Logo"/>
            <span>B4PhytoWeb</span>
        </a>
        <div style="display:flex;gap:.5rem;align-items:center">
            <button class="menu-toggle" aria-label="Apri menu">‚ò∞</button>
        </div>
        <nav aria-label="Principale">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="funzionalita.html">Funzionalit√†</a></li>
                <li><a href="vantaggi.html">Vantaggi</a></li>
                <li><a href="origine.html">Origine</a></li>
                <li><a href="supporto.html">Supporto</a></li>
                <li><a href="chi-siamo.html">Chi Siamo</a></li>
                <li><a href="lp-video.html"><span class="badge"><span class="dot"></span> Esplora</span></a></li>
            </ul>
        </nav>
    </div>
</header>

<section class="page-hero">
    <div class="wrap">
        <div>
            <span class="badge"><span class="dot"></span> Documentazione Tecnica</span>
            <h1>Manuale Operativo API Backend B4Web</h1>
            <p>Guida completa all'installazione, configurazione e utilizzo di tutti i moduli (User Manager, Data Manager, Connectors e Machine Learning) dell'applicazione API.</p>
        </div>
    </div>
</section>

<section class="section">
    <div class="container manual-layout">
        <nav class="sidebar-nav" aria-label="Sommario">
            <h3>Sommario</h3>
            <ul>
                <li><a href="#installazione">üõ†Ô∏è Installazione</a>
                    <ul>
                        <li><a href="#configurazione">Configurazione</a></li>
                        <li><a href="#esecuzione-locale">Esecuzione in locale</a></li>
                        <li><a href="#docker">Installazione su Docker</a></li>
                        <li><a href="#kubernetes">Installazione su Kubernetes</a></li>
                    </ul>
                </li>
                <li><a href="#avvio-server">üöÄ All‚Äôavvio del Server</a></li>
                <li><a href="#descrizione-file">üß© Descrizione dei file</a>
                    <ul>
                        <li><a href="#main-models">main.py & models.py</a></li>
                        <li><a href="#settings">settings.py</a></li>
                        <li><a href="#database-session">database_session.py</a></li>
                        <li><a href="#tableparams">tableparams.py</a></li>
                    </ul>
                </li>
                <li><a href="#usermanager">üë§ User Manager</a>
                    <ul>
                        <li><a href="#endpoints-users">Endpoint APIusers.py</a></li>
                        <li><a href="#esempi-users">Esempi di utilizzo</a></li>
                        <li><a href="#tasks">Script background_tasks.py</a></li>
                        <li><a href="#scheduler">Script scheduler.py</a></li>
                    </ul>
                </li>
                <li><a href="#datamanager">üì¶ Data Manager</a>
                    <ul>
                        <li><a href="#endpoints-data">Endpoint APIdata.py</a></li>
                        <li><a href="#insert-metabolite">Script insert_metabolite.py</a></li>
                        <li><a href="#insert-spectrometry">Script insert_spectrometry.py</a></li>
                        <li><a href="#insert-taxonomy">Script insert_taxonomy.py</a></li>
                        <li><a href="#metabolite-detail">Script metabolite_detail.py</a></li>
                        <li><a href="#insert-bioactivity">Script insert_bioactivity.py</a></li>
                        <li><a href="#index-py">Script index.py (Metodi search)</a></li>
                    </ul>
                </li>
                <li><a href="#connettori">üì¶ Connectors</a>
                    <ul>
                        <li><a href="#connector-excel">Da file Excel</a></li>
                        <li><a href="#connector-pubchem">Da PubChem</a></li>
                    </ul>
                </li>
                <li><a href="#machine-learning">üì¶ Machine Learning</a>
                    <ul>
                        <li><a href="#endpoints-ml">Endpoint APImodel.py</a></li>
                        <li><a href="#match-ms2">Script match_ms2.py</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <article class="main-content">

            <h2 id="installazione">üõ†Ô∏è INSTALLAZIONE</h2>
            <p>Questo progetto pu√≤ essere installato su **Docker** o su **Kubernetes**.</p>
            <div class="warning">
                **‚ö†Ô∏è Attenzione:** Prima di tutto, assicurati che il **database sia avviato** e correttamente configurato.
            </div>

            <h3 id="configurazione">üìÑ Configurazione</h3>
            <p>Tutte le variabili di ambiente si trovano nel file **`.env`**:</p>
            <pre>COMPOSE_PROJECT_NAME=b4web_backend_api
DB_HOST='host.docker.internal'
DB_USER='thisuser'
DB_PASSWORD='xxxxxyyyy123!'
DB_NAME='b4web'
APP_DOMAIN='localhost'
DB_PORT=5432
APP_PORT=8000
DB_DATA_PATH=b4web_db_data
admin_user='pippoAdmin'
admin_pass='pippoPW'
admin_email='pippo.disney@topolina.com'
SECRET_KEY='PIPPO_SECRET_KEY'
ALGORITHM='HS256'
SMTP_SERVER='smtp.disney.com'
SMTP_PORT=313
SMTP_USERNAME='disney-mail.blablablabla-0123456-yumyum'
SMTP_PASSWORD='plutoPW'
EMAIL_SENDER='DoNotReply@mailsend.disney.com'
ALLOWED_ORIGINS=http://localhost:3000
EXTTERNAL_ML_DATA_PATH='./external_ml_data'</pre>

            <h3 id="esecuzione-locale">‚ñ∂Ô∏è Esecuzione in locale</h3>
            <p>Per eseguire il backend localmente in ambiente di sviluppo:</p>
            <pre>uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --env-file .env</pre>

            <h3 id="docker">üê≥ Installazione su Docker</h3>
            <p>Per avviare il servizio con Docker:</p>
            <pre>docker-compose up --build -d</pre>
            <p>Per fermare il servizio:</p>
            <pre>docker-compose down</pre>

            <h3 id="kubernetes">‚ò∏Ô∏è Installazione su Kubernetes</h3>
            <p>Richiede cluster Kubernetes attivo e configurato con accesso a **Secrets**, **PVC**, e **Image Registry**.</p>

            <h4 id="namespace">1. Namespace</h4>
            <p>Assicurati che il namespace `b4web` esista:</p>
            <pre>kubectl create namespace b4web</pre>

            <h4 id="secrets">2. Secrets</h4>
            <p>I segreti sensibili (password, token, ecc.) sono montati da `SecretProviderClass` tramite CSI driver.</p>
            <p>**Esempio di Secret:**</p>
            <pre># b4web-env-secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: b4web-env-secrets
  namespace: b4web
type: Opaque
stringData:
  db-password: "xxxxyyyy123!"
  admin-pass: "pippoPW"
  smtp-password: "plutoPW"
  secret-key: "PIPPO_SECRET_KEY"</pre>
            <div class="warning">
                **‚ö†Ô∏è Attenzione:** Montato su `/mnt/secrets-store` in `deployment.yml`.
            </div>

            <h4 id="deployment">3. Deployment</h4>
            <p>Serve per avviare, aggiornare e mantenere in esecuzione una o pi√π repliche di un‚Äôapplicazione containerizzata, in questo caso l‚ÄôAPI chiamata `b4web-api`.</p>
            <p>Il file `deployment.yml` definisce l‚Äôapp:</p>
            <pre>kubectl apply -f deployment.yml</pre>
            <p>Contiene:</p>
            <ul>
                <li>1 replica dell‚Äôapp</li>
                <li>Immagine `inserire_la_tua_immagine_docker`</li>
                <li>Montaggio secrets tramite CSI</li>
                <li>Variabili d‚Äôambiente per connessione a DB, SMTP, ecc.</li>
            </ul>

            <h4 id="service">4. Service</h4>
            <p>Questo file definisce un oggetto Kubernetes di tipo **Service** per l‚Äôapplicazione `b4web-api`. Serve per:</p>
            <ul>
                <li>esporre la porta dell‚Äôapplicazione all‚Äôinterno del cluster,</li>
                <li>astrarre l‚Äôaccesso ai pod dietro un nome DNS stabile,</li>
                <li>permettere la comunicazione tra servizi Kubernetes (es. da un altro pod).</li>
            </ul>
            <p>Espone il backend all‚Äôinterno del cluster:</p>
            <pre>kubectl apply -f service.yml</pre>
            <p>Crea un punto di accesso stabile (**ClusterIP**) verso i pod gestiti dal deployment.</p>
            <p>Permette al traffico interno al cluster di raggiungere l‚ÄôAPI `b4web-api` attraverso l‚Äôindirizzo:</p>
            <pre>http://b4web-api.b4web.svc.cluster.local:8000</pre>
            <p>Rende possibile **scalare i pod** (es. 2, 3, 10) senza dover conoscere i singoli IP: il Service gestisce il bilanciamento.</p>
            <p>**‚úÖ Schema del flusso:**</p>
            <ol>
                <li>Richiesta dal cluster</li>
                <li>‚Üì</li>
                <li>Service: `b4web-api` (porta 8000)</li>
                <li>‚Üì</li>
                <li>Instrada ai pod con label `app=b4web-api`</li>
                <li>‚Üì</li>
                <li>Container che ascolta su targetPort: 8000</li>
            </ol>

            <h4 id="accesso">5. Accesso</h4>
            <p>In ambiente cloud (es. AKS), abbina un **Ingress Controller** o un **LoadBalancer** per rendere disponibile il servizio all‚Äôesterno.</p>
            <p>Settare il valore di `APP_DOMAIN` per l‚Äôambiente Kubernetes ad esempio:</p>
            <pre>https://b4web-api.neodatagroup.ai</pre>
            <p>All‚Äôavvio il sistema produrr√† uno **SWAGGER** con la descrizione degli endpoint, ad esempio:</p>
            <pre>https://b4web-api.neodatagroup.ai/docs#/</pre>
            <p>Settare il valore `ALLOWED_ORIGINS` per evitare problemi di **CORS**.</p>

            <hr/>

            <h2 id="avvio-server">üöÄ ALL‚ÄôAVVIO DEL SERVER</h2>
            <p>Quando esegui `main.py`, **FastAPI** avvia l‚Äôapp seguendo questi passaggi:</p>
            <ol>
                <li>**1. Creazione dell‚Äôapp FastAPI**
                    <pre>app = FastAPI()</pre>
                </li>
                <li>**2. Caricamento variabili d‚Äôambiente**
                    <pre>load_dotenv()</pre>
                    Carica `.env` e recupera le origini consentite per il CORS.
                </li>
                <li>**3. Configurazione CORS**
                    <pre>app.add_middleware(CORSMiddleware, ...)</pre>
                    Permette a frontend (es. React) su `localhost:3000` o domini configurati di comunicare con l‚ÄôAPI.
                </li>
                <li>**4. Registrazione dei router**
                    <pre>app.include_router(...) # utenti, dati, connettori</pre>
                    Collega i moduli che gestiscono:
                    <ul>
                        <li>`/users` ‚Üí autenticazione, gestione utenti</li>
                        <li>`/data` ‚Üí operazioni sul database locale (metaboliti, specie, spettrometria)</li>
                        <li>`/conn/pubchem` ‚Üí integrazione esterna con PubChem</li>
                        <li>`/conn/excel` ‚Üí caricamento dati da file Excel</li>
                    </ul>
                </li>
                <li>**5. Avvio del server**
                    <pre>if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)</pre>
                    Avvia il server FastAPI con Uvicorn, ascoltando sulla porta 8000.
                </li>
            </ol>

            <hr/>

            <h2 id="descrizione-file">üß© Descrizione dei file</h2>

            <h3 id="main-models">üìÑ `main.py` & `models.py`</h3>
            <ul>
                <li>Il **`main.py`** √® il punto d‚Äôingresso dell‚Äôapplicazione FastAPI. Registra middleware, include i router, carica l‚Äôambiente e avvia il server.</li>
                <li>Il **`models.py`** contiene **tutte le tabelle del database**, mappate con **SQLAlchemy ORM**.
                    <ul>
                        <li>**Autenticazione**: `User`, `OTP`</li>
                        <li>**Struttura biologica**: `Taxonomy`, `Sample`, `BiologicalReplicate`</li>
                        <li>**Dati metabolomici**: `Metabolite`, `ExperimentalMetabolite`, `Spectrometry`</li>
                        <li>**Dati PubChem/biochimici**: `Bioassay`, `Substance`, `MetaboliteBioassay`, `Bioactivity`, `BioactivityClass`, `BioassayClass`, `CompoundClass`</li>
                        <li>**Altro**: `Province`, `Municipality`, `Setting`, `MolecularClass`, `MolecularFormula`, `MolecularStructure`, `ResearchGroup`</li>
                    </ul>
                </li>
            </ul>

            <h3 id="settings">üìÑ `settings.py`</h3>
            <p>Classe `Config` che legge e centralizza le **variabili di configurazione ambientale** (es. `DB_HOST`, `DB_USER`, `DB_PASSWORD`). √à utilizzato da `database_session.py` per creare la connessione al database.</p>

            <h3 id="database-session">üìÑ `database_session.py`</h3>
            <p>Gestisce la connessione al database PostgreSQL. Crea un `SessionLocal` tramite SQLAlchemy ed espone la funzione **`get_db()`** per usarla nei router via `Depends(get_db)`.</p>

            <h3 id="tableparams">üìÑ `tableparams.py`</h3>
            <p>Definisce classi Python che rappresentano **dati in ingresso** da form, JSON o chiamate esterne. Questi oggetti sono usati per validare e passare dati ai metodi dei moduli `insert_*`.</p>
            <ul>
                <li>`MetaboliteParams`, `ExperimentalMetaboliteParams` ‚Üí usati per costruire record da inserire</li>
                <li>`BioassayParams`, `TaxonomyParams`, `SubstanceParams` ‚Üí dati provenienti da PubChem</li>
                <li>`UserParams` ‚Üí gestione utenti</li>
            </ul>

            <h3 id="come-interagiscono">üîÑ Come interagiscono</h3>
            <p>Ecco come i componenti interagiscono tra loro all‚Äôavvio e durante l‚Äôutilizzo:</p>
            <ol>
                <li>`main.py` ‚Üí avvia il server FastAPI</li>
                <li>`settings.py` ‚Üí legge configurazioni ambiente</li>
                <li>`database_session.py` ‚Üí apre connessione DB</li>
                <li>`models.py` ‚Üí definisce le tabelle su cui operano gli endpoint</li>
                <li>`tableparams.py` ‚Üí costruisce oggetti input da request/form</li>
                <li>`/routers` (APIusers, APIdata, APIconnector) ‚Üí definiscono le rotte</li>
                <li>`/connectors` e `/datamanager` ‚Üí logiche di elaborazione dati</li>
                <li>`/usermanager` ‚Üí gestione utenti e autenticazione</li>
            </ol>

            <hr/>

            <h2 id="usermanager">üë§ usermanager</h2>
            <p>Questo modulo contiene l‚Äôimplementazione delle API per la **gestione degli utenti** della piattaforma. Le funzionalit√† includono autenticazione, OTP, gestione password, creazione/verifica utente e operazioni amministrative.</p>

            <h4>Flusso completo di registrazione e login</h4>
            <ol>
                <li>Creazione utente (**superuser**) ‚Üí `/create_user`</li>
                <li>Verifica email (utente) ‚Üí `/verify_email?check=...`</li>
                <li>Richiesta OTP (utente) ‚Üí `/request_access`</li>
                <li>Login (utente) ‚Üí `/login` ‚Üí Ottieni **`access_token` JWT** per autenticazioni future</li>
                <li>Cambia password ‚Üí `/change_pasword`</li>
                <li>Password dimenticata ‚Üí `/reset_password`</li>
            </ol>
            <p>Il flusso di autenticazione √® **two-factor (2FA)** basato su password e OTP via email. Gli OTP vengono criptati con JWT, memorizzati su DB e verificati lato server.</p>

            <h3 id="endpoints-users">üåê Endpoint `APIusers.py`</h3>
            <p>Definisce una serie di endpoint FastAPI per la **gestione completa degli utenti** (registrazione, autenticazione sicura con OTP, gestione delle password, assegnazione dei ruoli e verifica e-mail). Utilizza **modelli Pydantic**, **SQLAlchemy** e **JWT**. L'endpoint √® montato in `main.py` con il prefisso `/users`.</p>

            <h4>üîê Autenticazione e Accesso</h4>
            <ul>
                <li>**Richiesta OTP (`/request_access` [POST])**: Verifica credenziali e invia un OTP via email.
                    <ul>
                        <li>**Funzioni usate**: `generate_otp()`, `store_otp_in_db()`, `send_otp_email()`.</li>
                    </ul>
                </li>
                <li>**Login (`/login` [POST])**: Login tramite username, password e OTP.
                    <ul>
                        <li>**Processo**: Verifica credenziali e OTP usando `verify_otp_from_db()` e controlla gli OTP scaduti. Ritorna `LoginResponse` con **token JWT** generato.</li>
                    </ul>
                </li>
            </ul>

            <h4>üîÅ Gestione Password</h4>
            <ul>
                <li>**Cambio Password (`/change_password` [POST])**: Cambio password autenticato. Richiede autenticazione via token.</li>
                <li>**Reset Password (`/reset_password` [POST])**: Reset tramite username ed email.
                    <ul>
                        <li>**Processo**: Verifica username + email, imposta nuova password, imposta `checked = False` e invia una mail di verifica.</li>
                    </ul>
                </li>
            </ul>

            <h4>üë§ Gestione Utenti</h4>
            <ul>
                <li>**Creazione Utente (`/create_user` [POST])**: Crea un nuovo utente. **Restrizioni**: Solo superuser. Invia mail di verifica (`send_verification_email()`).</li>
                <li>**Verifica Email (`/verify_email` [GET])**: Attiva l‚Äôaccount tramite token di conferma in URL. Imposta `user.checked = True`.</li>
                <li>**Elenco Utenti (`/get_list` [GET])**: Lista utenti con paginazione (default: `page=1`, `limit=10`). **Restrizioni**: Solo superuser.</li>
                <li>**Cancellazione (`/delete/{user_id}` [DELETE])**: Elimina un utente. **Restrizioni**: Solo superuser.</li>
                <li>**Cambio Ruolo (`/change_role` [PUT])**: Modifica ruolo utente. **Restrizioni**: Solo superuser.</li>
            </ul>

            <h3 id="esempi-users">üöÄ Esempi di utilizzo degli endpoint</h3>
            <p>Esempi di richieste e risposte per la gestione utenti:</p>
            <details>
                <summary>1. Creazione utente (/create_user)</summary>
                <pre>POST /create_user
Authorization: Bearer &lt;token_superuser&gt;
{
"username": "mario",
"email": "mario@esempio.com",
"password": "password123",
"type": "guest"
}
Risposta:
{
"message": "User created successfully. Verification email sent.",
"username": "mario",
"type": "guest"
}</pre>
            </details>
            <details>
                <summary>2. Verifica email (/verify_email)</summary>
                <p>URL da email:</p>
                <pre>GET /verify_email?check=&lt;token&gt;
Risposta:
{
"message": "Email verified successfully.",
"email": "mario@esempio.com"
}</pre>
            </details>
            <details>
                <summary>3. Richiesta OTP (/request_access)</summary>
                <pre>POST /request_access
{
"username": "mario",
"password": "password123"
}
Risposta:
{
"message": "OTP sent to registered email"
}</pre>
            </details>
            <details>
                <summary>4. Login con OTP (/login)</summary>
                <pre>POST /login
{
"username": "mario",
"password": "password123",
"otp": "123456"
}
Risposta:
{
"access_token": "&lt;JWT_TOKEN&gt;",
"token_type": "bearer",
"user_type": "guest"
}</pre>
            </details>
            <details>
                <summary>5. Cambio password (/change_password)</summary>
                <pre>POST /change_password
Authorization: Bearer &lt;JWT_TOKEN&gt;
{
"username": "mario",
"old_password": "password123",
"new_password": "nuovaPassword"
}</pre>
            </details>
            <details>
                <summary>6. Reset password (/reset_password)</summary>
                <pre>POST /reset_password
{
"username": "mario",
"email": "mario@esempio.com",
"new_password": "passwordReset"
}</pre>
                <p>Invier√† una nuova email di verifica all‚Äôutente.</p>
            </details>
            <details>
                <summary>7. Elenco utenti (/get_list)</summary>
                <pre>GET /get_list?page=1&limit=10
Authorization: Bearer &lt;token_superuser&gt;</pre>
            </details>
            <details>
                <summary>8. Cancellazione utente (/delete/{user_id})</summary>
                <pre>DELETE /delete/5
Authorization: Bearer &lt;token_superuser&gt;</pre>
            </details>
            <details>
                <summary>9. Modifica ruolo utente (/change_role)</summary>
                <pre>PUT /change_role
Authorization: Bearer &lt;token_superuser&gt;
{
"user_id": 5,
"new_role": "analyst"
}</pre>
            </details>

            <h3 id="tasks">üìÅ Script `background_tasks.py`</h3>
            <p>Script ausiliario per la **pulizia automatica degli OTP scaduti o usati**.</p>
            <ul>
                <li>`cleanup_expired_otps(db)`: Cancella gli OTP scaduti o gi√† utilizzati (oltre i 5 minuti).</li>
                <li>`schedule_cleanup()`: Avvia un ciclo infinito che esegue `cleanup_expired_otps` ogni 5 minuti.</li>
            </ul>

            <h3 id="scheduler">üìÅ Script `scheduler.py`</h3>
            <p>Script per schedulare automaticamente la **pulizia periodica degli OTP** ogni 5 minuti utilizzando **APScheduler**. Utilizza `AsyncIOScheduler` e importa `cleanup_expired_otps` da `APIusers.py`.</p>

            <hr/>

            <h2 id="datamanager">üì¶ datamanager</h2>
            <p>Il modulo gestisce l‚Äôinserimento, la trasformazione, la consultazione e l‚Äôaggiornamento dei dati relativi ai **metaboliti**, **spettrometria** e dettagli associati alle **specie biologiche**.</p>

            <h3 id="endpoints-data">üåê Endpoint `APIdata.py`</h3>
            <p>Implementa diverse API dedicate alla gestione dei dati relativi alla spettrometria, ai metaboliti sperimentali e alla tassonomia, fungendo da controller per il frontend.</p>
            <p>L'endpoint √® montato in `main.py` con il prefisso `/data`.</p>

            <h4>üß± Modelli (Request & Response)</h4>
            <p>Modelli (strutture dati) usati dagli endpoint:</p>
            <ul>
                <li>`MetaboliteModel`, `SpectrometryRequestModel`, `MetaboliteResponse`, `MetaboliteDetailResponse`, `TaxonomyDetailResponse`.</li>
                <li>Modelli per la ricerca sperimentale: `ExperimentalMetaboliteResponse`, `FormulaRTResponse`, `FragmentsResponse`.</li>
                <li>Modelli per Bioactivity, Bioassay e Replicati Biologici: `BioactivityInsertRequest`, `BioassayClassResponse`, `BiologicalReplicateItem`.</li>
            </ul>

            <h4>‚öôÔ∏è Funzioni interne (logiche)</h4>
            <p>Le logiche utilizzate provengono da moduli importati come:</p>
            <ul>
                <li>`InsertMetaboliteLogic`, `InsertSpectrometryLogic`, `InsertTaxonomyLogic`, `InsertBioactivityLogic`</li>
                <li>`FragmentedMetabolites` e metodi `*_data_manipulation` (es. `metabolitedetail_data_manipulation`)</li>
            </ul>

            <h4>üöÄ Endpoint Data Manager</h4>
            <p>Sintesi degli endpoint:</p>
            <details>
                <summary>üîç Ricerca Metaboliti</summary>
                <ul>
                    <li>`GET /get_all_metabolites`</li>
                    <li>`GET /get_metabolite` (per nome)</li>
                    <li>`GET /data/metabolite_synonyms` (per sinonimo)</li>
                </ul>
            </details>
            <details>
                <summary>üß™ Gestione Spettrometria</summary>
                <ul>
                    <li>`GET /get_spectrometry/{id}` (imposta adducts e settings)</li>
                    <li>`POST /add_spectrometry` / `POST /data/add_spectrometry`</li>
                    <li>`DELETE /data/delete_spectrometry/{id}`</li>
                    <li>`GET /data/get_all_spectrometries` (lista con paginazione)</li>
                </ul>
            </details>
            <details>
                <summary>‚ûï Inserimento Metaboliti</summary>
                <ul>
                    <li>`POST /add_metabolite` (inserisce o aggiorna)</li>
                </ul>
            </details>
            <details>
                <summary>üß¨ Ricerca e Gestione Tassonomica</summary>
                <ul>
                    <li>Ricerca per Specie, Genere e Famiglia (`GET /get_all_species`, `GET /get_specie`, `GET /get_all_genera`, `GET /get_genus`, `GET /get_all_families`, `GET /get_family`)</li>
                    <li>`DELETE /data/delete_taxonomy/{id_taxa}` (eliminazione a cascata)</li>
                    <li>`POST /data/add_taxonomy`, `PUT /data/update_taxonomy`</li>
                    <li>`GET /data/taxonomy_synonyms` (ricerca per sinonimi)</li>
                </ul>
            </details>
            <details>
                <summary>üìã Dettaglio</summary>
                <ul>
                    <li>`GET /metabolite_detail` (dettaglio completo metabolita)</li>
                    <li>`GET /taxonomy_detail` (dettaglio completo tassonomia)</li>
                </ul>
            </details>
            <details>
                <summary>üß≠ Ricerca per Dati Sperimentali</summary>
                <ul>
                    <li>`GET /search_metabolite_by_experimental_mz`</li>
                    <li>`GET /search_metabolite_by_formula_rt`</li>
                    <li>`GET /search_metabolite_by_fragments`</li>
                </ul>
            </details>
            <details>
                <summary>üß´ Gestione Bioactivity, Classi e Replicati</summary>
                <ul>
                    <li>Gestione Bioactivity: `POST /data/add_bioactivity`, `PUT /data/update_bioactivity/{id}`, `DELETE /data/delete_bioactivity/{id}`, `GET /data/get_all_bioactivities`</li>
                    <li>Gestione Classi: Endpoint separati per `BioactivityClass` e `BioassayClass` (Add/Update/Delete/Get All)</li>
                    <li>Gestione Replicati Biologici: `POST /data/add_biological_replicate`, `DELETE /data/delete_biological_replicate`, `GET /data/get_list_biologicalreplicate`</li>
                </ul>
            </details>

            <h3 id="insert-metabolite">üìÅ Script `insert_metabolite.py`</h3>
            <p>Contiene diverse funzioni per gestire l‚Äôinserimento e la manipolazione dei dati relativi ai metaboliti.</p>

            <h4>Procedura ETL</h4>
            <p>**üü¢ Extract**</p>
            <ul>
                <li>Estrazione dei dati dal JSON tramite `load_bioassay(json_string)` e `load_substance(json_string, compound_name)`.</li>
            </ul>
            <p>**üîµ Transform**</p>
            <ul>
                <li>Le funzioni di estrazione convertono i dati JSON in oggetti `BioassayParams` e `SubstanceParams`.</li>
                <li>`metaboliteinsert_data_manipulation(form_data, db)` trasforma i dati del modulo in oggetti da inserire, gestendo anche la conversione di immagini in dati binari.</li>
            </ul>
            <p>**üî¥ Load**</p>
            <ul>
                <li>Inserimento di nuovi metaboliti, strutture molecolari, bioassay, sostanze, impostazioni, campioni, replicati biologici e metaboliti sperimentali nel database.</li>
            </ul>

            <h4>üõ†Ô∏è Metodo `metaboliteinsert_data_manipulation`</h4>
            <p>Metodo core (`metaboliteinsert_data_manipulation`) che gestisce l'intero flusso ETL per l'inserimento dei dati dei metaboliti nel database. Gestisce l'estrazione, la trasformazione (conversione immagine 2D in binario) e il caricamento di tutte le entit√† correlate (strutture molecolari, bioassay, campioni, replicati ecc.). Include la gestione delle eccezioni e il **rollback della transazione** in caso di errore.</p>

            <h4>üß© Classe `BioactivityLoading`</h4>
            <p>Responsabile del recupero e della trasformazione dei dati **biochimici** (bioassay) e **chimici** (substances) da risposte JSON, tipicamente da PubChem.</p>
            <ul>
                <li>`load_bioassay(json_string: str)`: Elabora i dati relativi ai test biochimici (AID, titolo, tipo, descrizione) dal JSON e li raggruppa in un oggetto `BioassayParams`.</li>
                <li>`load_substance(json_string: str, compound_name: str)`: Elabora le informazioni chimiche (numero di registrazione, nome IUPAC, nome commerciale) e le organizza in un oggetto `SubstanceParams`.</li>
            </ul>

            <h3 id="insert-spectrometry">üìÅ Script `insert_spectrometry.py`</h3>
            <p>Questo modulo gestisce l‚Äôinserimento dei dati di **spettrometria LC-MS** (grafici, picchi, parametri strumentali).</p>

            <h4>Procedura ETL</h4>
            <p>**üü¢ Extract**: Ricezione di `intensity_threshold`, `filtered_peaks`, `image_base64` (opzionale), parametri strumentali e `metabolite_name`.</p>
            <p>**üîµ Transform**: Se non fornita, generazione automatica del grafico dello spettro a partire dai picchi e conversione in base64. Preparazione della struttura dati per il database.</p>
            <p>**üî¥ Load**: Inserimento di un nuovo record nella tabella **Spectrometry**, associando i dati al metabolita e al setting strumentale.</p>

            <h4>üß© Classe `InsertSpectrometryLogic`</h4>
            <p>Classe principale per elaborare e caricare i dati spettrometrici.</p>
            <ul>
                <li>`create_graph_base64(filtered_peaks)`: Genera un grafico dello spettro in formato base64.</li>
                <li>`insert_spectrometry_data(data, db: Session)`: Gestisce l‚Äôintero flusso di inserimento dei dati spettrometrici, dalla validazione alla creazione del grafico, fino al salvataggio nel database.</li>
            </ul>

            <h3 id="insert-taxonomy">üìÅ Script `insert_taxonomy.py`</h3>
            <p>Gestisce l'inserimento, aggiornamento, eliminazione e recupero di **tassonomie** e **campioni**.</p>

            <h4>Procedura ETL</h4>
            <p>**üü¢ Extract**: Dati di tassonomie e campioni ricevuti da API o form. Possibile recupero automatico da PubChem se alcune informazioni tassonomiche sono mancanti.</p>
            <p>**üîµ Transform**: I dati ricevuti vengono validati e arricchiti. Date e riferimenti a entit√† collegate (comuni, tassonomie) vengono verificati.</p>
            <p>**üî¥ Load**: Inserimento, aggiornamento ed eliminazione di tassonomie e gestione dei campioni.</p>

            <h4>üß© Classe `InsertTaxonomyLogic`</h4>
            <p>Implementa tutti i metodi necessari per la gestione delle tassonomie e dei campioni.</p>
            <ul>
                <li>**Tassonomie**: `add_taxonomy` (recupera dati mancanti da PubChem se necessario), `update_taxonomy`, `delete_taxonomy`.</li>
                <li>**Campioni**: `add_sample`, `update_sample`, `delete_sample`.</li>
            </ul>

            <h3 id="metabolite-detail">üìÅ Script `metabolite_detail.py`</h3>
            <p>Responsabile della generazione e aggregazione dei **dettagli completi relativi a un metabolita**. Lavora su dati esistenti combinandoli per fornire una visione completa.</p>

            <h4>Procedura ETL (interpretata come aggregazione)</h4>
            <p>**üü¢ Extract**: I metodi interrogano il DB (usando SQLAlchemy Session) per estrarre informazioni chimiche, bioassay, tassonomiche, frammenti sperimentali e spettri LC-MS.</p>
            <p>**üîµ Transform**: I dati estratti sono trasformati in dizionari Python strutturati e formattati (raggruppati per specie/impostazione sperimentale).</p>
            <p>**üî¥ Load**: Corrisponde alla preparazione di una **risposta aggregata** per il client API.</p>

            <h4>üõ†Ô∏è Metodo `metabolitedetail_data_manipulation`</h4>
            <p>Aggrega tutte le informazioni disponibili su un metabolita (formula, massa, struttura, bioassay, dati spettrometrici, tassonomici), organizzando frammenti e dati LC-MS per specie e configurazione strumentale.</p>

            <h4>üß© Classe `FragmentedMetabolites`</h4>
            <ul>
                <li>`get_fragmented_metabolites_by_name_species`: Raccoglie tutti i frammenti LC-MS registrati per un metabolita e una specie, con i relativi parametri sperimentali.</li>
            </ul>

            <h4>üß© Classe `UpdateMetabolite`</h4>
            <ul>
                <li>`update_metabolite_check(forms: dict, db: Session)`: Permette la modifica controllata dei dati di un metabolita (rinomina, formula, massa, parametri spettrometrici, ecc.), mantenendo l'integrit√† delle relazioni.</li>
            </ul>

            <h3 id="insert-bioactivity">üìÅ Script `insert_bioactivity.py`</h3>
            <p>Garantisce l‚Äôinserimento di un nuovo record di bioattivit√†.</p>

            <h4>Procedura ETL</h4>
            <p>**üü¢ Extract**: Il dizionario di dati fornito in input √® considerato il dato estratto.</p>
            <p>**üîµ Transform**: I metodi della classe interrogano il database per verificare l'esistenza e creare, se necessario, i record correlati (`ResearchGroup`, `Taxonomy`, `Municipality`, `Sample`, `Setting`, `BiologicalReplicate`, `BioassayClass`, `BioactivityClass`).</p>
            <p>**üî¥ Load**: Creazione e salvataggio del nuovo record **Bioactivity**.</p>

            <h3 id="index-py">üìÅ Script `index.py`</h3>
            <p>Script di **orchestrazione**: coordina le chiamate tra moduli, gestisce input e li inoltra ai componenti logici. Funge da facciata coordinatrice.</p>

            <h4>üîç Metodi search</h4>
            <p>Metodi per la ricerca di metaboliti, specie e famiglie.</p>
            <ul>
                <li>`search_metabolites`, `search_species`, `search_all_genus`, `search_all_families`</li>
                <li>`search_metabolite`, `search_specie`, `search_genu`, `search_family`</li>
                <li>`search_experimental_mz`: Ricerca per m/z sperimentale, tipo e finestra di errore</li>
                <li>`search_formula_rt`: Ricerca opzionale per formula molecolare e/o valore RT e finestra di errore RT</li>
                <li>`search_metabolites_by_fragments`: Ricerca attraverso frammenti, definendo finestra di errore e filtro per frammenti positivi/negativi</li>
            </ul>

            <hr/>

            <h2 id="connettori">üì¶ Connectors</h2>
            <p>Modulo che permette di interagire con dati esterni, come quelli da **PubChem** e da **file Excel**. Tutti gli endpoint sono protetti da autenticazione (`current_user`).</p>

            <h3 id="connector-excel">Da file Excel</h3>
            <p>API per l'importazione di dati da file Excel. Montate con prefisso `/conn/excel`.</p>
            <h4>üöÄ Endpoint Excel</h4>
            <ul>
                <li>**`üß´ POST /spectrometry_graph`**: Carica file Excel spettrometria, filtra i picchi per soglia di intensit√† relativa (%BIC) e restituisce dati filtrati e grafico in base64.</li>
                <li>**`üî¨ POST /add_bioactivity`**: Importa e inserisce dati di bioactivity da file Excel o CSV.</li>
                <li>**`üî¨ POST /add_taxonomy_and_sample`**: Carica file Excel con dati di tassonomia e/o campioni, li valida e li inserisce.</li>
                <li>**`üî¨ POST /add_experimental_metabolite`**: Carica file Excel o CSV con dati degli experimental metabolite (template ufficiale), li valida e li inserisce.</li>
            </ul>

            <h3 id="connector-pubchem">Da PubChem</h3>
            <p>API per l'importazione di dati da PubChem. Montate con prefisso `/conn/pubchem`.</p>
            <h4>üöÄ Endpoint PubChem</h4>
            <ul>
                <li>**`üî¨ GET /get_metabolite_data`**: Dato il nome di un metabolita, ottiene da PubChem informazioni chimiche di base (formula molecolare, peso, SMILES, InChI).</li>
                <li>**`üß¨ GET /get_pubchem_taxonomy`**: Dato il nome di un organismo, restituisce l‚Äôintera tassonomia PubChem.</li>
                <li>**`üìñ GET /get_pug_view_data`**: Restituisce il contenuto completo della pagina PUG-View di PubChem, dato il `cid` del composto.</li>
                <li>**`üß™ GET /get_bioassays_from_cid`**: Ottiene tutti i bioassay associati a un metabolita da PubChem, usando il suo `cid`.</li>
                <li>**`üìä GET /get_bioassays_from_aid`**: Cerca i bioassay prendendo gli AID dal database interno (`MetaboliteBioassay`) e recuperando i dettagli da PubChem.</li>
            </ul>

            <hr/>

            <h2 id="machine-learning">üì¶ machine_learning</h2>
            <p>Modulo per elaborare in maniera avanzata le spettrometrie concentrandosi sulle **similarit√†**.</p>

            <h3 id="endpoints-ml">üåê Endpoint `APImodel.py`</h3>
            <p>Definisce un endpoint FastAPI che permette di calcolare la **similarit√† tra spettri** forniti in input con spettri presenti nella base di dati di **MassBank**. L'endpoint √® montato con prefisso `/ml`.</p>

            <h4>üöÄ Endpoint Machine Learning</h4>
            <p>Protetti da autenticazione; utenti `visitor` o `guest` non hanno accesso.</p>
            <ul>
                <li>**`üß™ POST /ml/spectrum_match`**: Calcola la similarit√† dello spettro, accettando query params per file di input, `top_n`, `machine`, `ion_mode` e `compound_class`.</li>
            </ul>

            <h3 id="match-ms2">üìÅ Script `match_ms2.py`</h3>
            <p>Contiene metodi per gestire il caricamento dello spettro e il calcolo della similarit√†.</p>

            <h4>Procedura ETL</h4>
            <p>**üü¢ Extract**: La procedura di estrazione dati √® effettuata in `load_spectra_from_json`. √à possibile applicare filtri (`matches_filters`).</p>
            <p>**üîµ Transform**: I dati estratti vengono elaborati per essere convertiti in oggetti di tipo `Spectrum`.</p>
            <p>**üî¥ Load**: Dopo il calcolo del match (`match_spectra`), il risultato viene generato tramite `generate_output` e salvato come file JSON.</p>

            <h4>üõ†Ô∏è Metodi principali</h4>
            <ul>
                <li>`matches_filters(item: JSON, filters: str)`: Applica filtri su tipo di macchina, `ion_mode` e classe del composto.</li>
                <li>`find_ready_reference(base_dir: path)`: Determina la directory attiva tra `reference_db_a` e `reference_db_b` (strategia **Zero-Downtime A/B**).</li>
                <li>`load_spectra_from_json(...)`: Carica un file JSON e inserisce i dati (intesit√†, metadati, m/z) in un oggetto `Spectrum`.</li>
                <li>`match_spectra(...)`: Metodo principale. Calcola la similarit√† mediante metodo del **Modified Cosine** in modalit√† simmetrica. Estrae i primi `top_n` match.</li>
            </ul>
        </article>
    </div>
</section>


<footer class="footer">
    <div class="cols container">
        <div>
            <div class="brand" style="margin-bottom:.5rem">
                <img src="assets/logo.svg" alt="" width="28" height="28"/>
                <span>B4PhytoWeb</span>
            </div>
            <p class="muted">
                B4Web: una tassonomia Biomolecolare, delle Biofonti e delle Bioattivit√† per liberare il potenziale della Biodiversit√† ‚Äì finanziato da: 
                Commissione Europea - Next Generation EU, Missione 4 Componente 1 CUP C33C24000340001
            </p>
        </div>

        <div>
            <h3>Sezioni</h3>
            <ul>
                <li><a href="funzionalita.html">Funzionalit√†</a></li>
                <li><a href="vantaggi.html">Vantaggi</a></li>
                <li><a href="origine.html">Origine</a></li>
                <li><a href="supporto.html">Supporto</a></li>
                <li><a href="lp-video.html">Esplora la piattaforma</a></li>
            </ul>
        </div>

        <div class="footer-logos" style="display:flex;flex-wrap:wrap;gap:1rem;align-items:center;justify-content:flex-start">
            <img src="assets/20240209112418!LOGO_italiadomani.jpg" alt="Italia Domani" height="50" />
            <img src="assets/EN_Funded_by_the_European_Union_RGB_POS.png" alt="Finanziato dall'Unione Europea" height="50" />
            <img src="assets/LOGO_UniversitaRicerca.jpg" alt="Ministero dell'Universit√† e della Ricerca" height="50" />
            <img src="assets/Logo_NBFC.png" alt="NBFC" height="50" />
        </div>
    </div>
</footer>
<script src="assets/script.js"></script>
</body>
</html>
