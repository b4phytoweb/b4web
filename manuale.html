<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Documentazione Tecnica â€” B4PhytoWeb API</title>
    <meta name="description" content="Manuale di installazione e descrizione dei moduli e degli endpoint dell'API backend B4Web.">
    <style>
        :root {
            --color-primary: #007bff;
            --color-secondary: #6c757d;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #17a2b8;
            --color-light: #f8f9fa;
            --color-dark: #343a40;
            --color-text-body: #212529;
            --color-text-muted: #6c757d;
            --font-inter: 'Inter', sans-serif;
            --spacing-unit: 1rem;
        }

        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-inter);
            color: var(--color-text-body);
            line-height: 1.6;
            background-color: #ffffff;
            scroll-behavior: smooth;
        }

        a {
            color: var(--color-primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .wrap, .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-unit) * 2;
        }

        .section {
            padding: var(--spacing-unit) * 4 0;
        }

        /* Header/Nav (as per new template) */
        .nav {
            border-bottom: 1px solid var(--color-light);
            background: var(--color-dark);
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-unit) 2rem;
        }

        .brand {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--color-light);
        }

        .brand img {
            height: 28px;
            width: 28px;
            margin-right: 0.5rem;
            /* Placeholder for SVG styling */
            background-color: var(--color-primary);
            border-radius: 4px;
        }

        .navbar nav ul {
            list-style: none;
            display: flex;
            gap: 1.5rem;
        }

        .navbar nav a {
            color: var(--color-light);
            text-decoration: none;
            font-weight: 400;
        }
        
        .navbar nav a:hover {
            color: var(--color-primary);
            text-decoration: none;
        }

        .menu-toggle {
            display: none; /* Hide toggle button on desktop */
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            background-color: #d1e7dd;
            color: #0f5132;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .badge .dot {
            width: 8px;
            height: 8px;
            background-color: #0f5132;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        /* Hero Section (Customized for Documentation) */
        .page-hero {
            background: #e9f0ff; /* Light blue background for hero */
            padding: 4rem 0;
            border-bottom: 1px solid #c2d2ff;
        }
        
        .page-hero .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-unit) 2rem;
        }
        
        .page-hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--color-dark);
        }
        
        .page-hero p {
            font-size: 1.1rem;
            color: var(--color-text-body);
        }

        /* Manual Layout (Sidebar + Content) */
        .manual-layout {
            display: grid;
            grid-template-columns: 250px 1fr; /* 250px for sidebar, rest for content */
            gap: 3rem;
            align-items: start;
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            position: sticky;
            top: 2rem;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 6px;
            background-color: var(--color-light);
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }

        .sidebar-nav ul {
            list-style: none;
        }

        .sidebar-nav > ul > li {
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid #ddd;
        }
        
        .sidebar-nav > ul > li:first-child {
            border-top: none;
            margin-top: 0;
        }

        .sidebar-nav > ul > li > a {
            font-weight: 700;
            display: block;
            padding: 0.25rem 0;
            color: var(--color-dark);
        }

        .sidebar-nav ul ul {
            padding-left: 1rem;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .sidebar-nav ul ul li {
            margin-top: 0.25rem;
        }

        .sidebar-nav ul ul a {
            font-weight: 400;
            color: var(--color-text-body);
            display: block;
        }
        
        /* Main Content */
        .main-content {
            padding: 0 1rem;
        }
        
        .main-content h2 {
            font-size: 2rem;
            margin: 2rem 0 1rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
            color: var(--color-primary);
        }
        
        .main-content h3 {
            font-size: 1.5rem;
            margin: 1.5rem 0 0.75rem;
            color: var(--color-dark);
        }
        
        .main-content h4 {
            font-size: 1.25rem;
            margin: 1rem 0 0.5rem;
            color: var(--color-text-body);
        }

        .main-content pre {
            background: #282c34;
            color: #abb2bf;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .main-content ul, .main-content ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .main-content ul li, .main-content ol li {
            margin-bottom: 0.5rem;
        }

        .main-content p {
            margin-bottom: 1rem;
        }

        .main-content .code-block-title {
            font-weight: 600;
            color: var(--color-primary);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .main-content .warning {
            padding: 1rem;
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            margin: 1rem 0;
            color: #664d03;
        }
        
        /* Footer Styles (as per new template) */
        .footer {
            background: var(--color-dark);
            color: var(--color-light);
            padding: 3rem 0;
            border-top: 5px solid var(--color-primary);
        }

        .footer .cols {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr;
            gap: 2rem;
        }

        .footer .brand {
            color: var(--color-light);
        }

        .footer h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--color-light);
        }

        .footer ul {
            list-style: none;
        }

        .footer ul a {
            color: #bbb;
            display: block;
            padding: 0.25rem 0;
        }

        .footer .muted {
            font-size: 0.85rem;
            color: #aaa;
        }

        .footer-logos img {
            opacity: 0.8;
            max-width: 100px;
            height: auto;
        }
        
        /* Media Queries for Responsiveness (optional but good practice) */
        @media (max-width: 992px) {
            .manual-layout {
                grid-template-columns: 1fr;
            }

            .sidebar-nav {
                position: relative;
                top: auto;
            }
            
            .footer .cols {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
<header class="nav">
    <div class="navbar">
        <a class="brand" href="index.html" aria-label="B4PhytoWeb Home">
            <img src="assets/logo.svg" alt="Logo"/>
            <span>B4PhytoWeb</span>
        </a>
        <div style="display:flex;gap:.5rem;align-items:center">
            <button class="menu-toggle" aria-label="Apri menu">â˜°</button>
        </div>
        <nav aria-label="Principale">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="funzionalita.html">FunzionalitÃ </a></li>
                <li><a href="vantaggi.html">Vantaggi</a></li>
                <li><a href="origine.html">Origine</a></li>
                <li><a href="supporto.html">Supporto</a></li>
                <li><a href="chi-siamo.html">Chi Siamo</a></li>
                <li><a href="lp-video.html"><span class="badge"><span class="dot"></span> Esplora</span></a></li>
            </ul>
        </nav>
    </div>
</header>

<section class="page-hero">
    <div class="wrap">
        <div>
            <span class="badge"><span class="dot"></span> Documentazione Tecnica</span>
            <h1>Manuale Operativo API Backend B4Web</h1>
            <p>Guida completa all'installazione, configurazione e utilizzo di tutti i moduli (User Manager, Data Manager, Connectors e Machine Learning) dell'applicazione API.</p>
        </div>
    </div>
</section>

<section class="section">
    <div class="container manual-layout">
        <nav class="sidebar-nav" aria-label="Sommario">
            <h3>Sommario</h3>
            <ul>
                <li><a href="#installazione">ğŸ› ï¸ Installazione</a>
                    <ul>
                        [cite_start]<li><a href="#configurazione">Configurazione</a> [cite: 2]</li>
                        [cite_start]<li><a href="#esecuzione-locale">Esecuzione in locale</a> [cite: 3]</li>
                        [cite_start]<li><a href="#docker">Installazione su Docker</a> [cite: 4]</li>
                        [cite_start]<li><a href="#kubernetes">Installazione su Kubernetes</a> [cite: 5]</li>
                    </ul>
                </li>
                [cite_start]<li><a href="#avvio-server">ğŸš€ Allâ€™avvio del Server</a> [cite: 11]</li>
                [cite_start]<li><a href="#descrizione-file">ğŸ§© Descrizione dei file</a> [cite: 12]
                    <ul>
                        [cite_start]<li><a href="#main-models">main.py & models.py</a> [cite: 13]</li>
                        [cite_start]<li><a href="#settings">settings.py</a> [cite: 14]</li>
                        [cite_start]<li><a href="#database-session">database_session.py</a> [cite: 15]</li>
                        [cite_start]<li><a href="#tableparams">tableparams.py</a> [cite: 16]</li>
                    </ul>
                </li>
                [cite_start]<li><a href="#usermanager">ğŸ‘¤ User Manager</a> [cite: 18]
                    <ul>
                        [cite_start]<li><a href="#endpoints-users">Endpoint APIusers.py</a> [cite: 19]</li>
                        [cite_start]<li><a href="#esempi-users">Esempi di utilizzo</a> [cite: 24]</li>
                        [cite_start]<li><a href="#tasks">Script background_tasks.py</a> [cite: 25]</li>
                        [cite_start]<li><a href="#scheduler">Script scheduler.py</a> [cite: 27]</li>
                    </ul>
                </li>
                [cite_start]<li><a href="#datamanager">ğŸ“¦ Data Manager</a> [cite: 28]
                    <ul>
                        [cite_start]<li><a href="#endpoints-data">Endpoint APIdata.py</a> [cite: 29]</li>
                        [cite_start]<li><a href="#insert-metabolite">Script insert_metabolite.py</a> [cite: 33]</li>
                        [cite_start]<li><a href="#insert-spectrometry">Script insert_spectrometry.py</a> [cite: 41]</li>
                        [cite_start]<li><a href="#insert-taxonomy">Script insert_taxonomy.py</a> [cite: 45]</li>
                        [cite_start]<li><a href="#metabolite-detail">Script metabolite_detail.py</a> [cite: 49]</li>
                        [cite_start]<li><a href="#insert-bioactivity">Script insert_bioactivity.py</a> [cite: 60]</li>
                        [cite_start]<li><a href="#index-py">Script index.py (Metodi search)</a> [cite: 63]</li>
                    </ul>
                </li>
                [cite_start]<li><a href="#connettori">ğŸ“¦ Connectors</a> [cite: 65]
                    <ul>
                        [cite_start]<li><a href="#connector-excel">Da file Excel</a> [cite: 66]</li>
                        [cite_start]<li><a href="#connector-pubchem">Da PubChem</a> [cite: 72]</li>
                    </ul>
                </li>
                [cite_start]<li><a href="#machine-learning">ğŸ“¦ Machine Learning</a> [cite: 79]
                    <ul>
                        [cite_start]<li><a href="#endpoints-ml">Endpoint APImodel.py</a> [cite: 80]</li>
                        [cite_start]<li><a href="#match-ms2">Script match_ms2.py</a> [cite: 83]</li>
                    </ul>
                </li>
            </ul>
        </nav>

        <article class="main-content">

            <h2 id="installazione">ğŸ› ï¸ INSTALLAZIONE</h2>
            [cite_start]<p>Questo progetto puÃ² essere installato su **Docker** o su **Kubernetes**[cite: 91]. [cite_start]Prima di procedere, assicurati che il **database sia avviato** e correttamente configurato[cite: 91].</p>

            [cite_start]<h3 id="configurazione">ğŸ“„ Configurazione [cite: 92]</h3>
            [cite_start]<p>Tutte le variabili di ambiente si trovano nel file **`.env`**[cite: 93]:</p>
            [cite_start]<pre>COMPOSE_PROJECT_NAME=b4web_backend_api [cite: 94]
[cite_start]DB_HOST='host.docker.internal' [cite: 95]
[cite_start]DB_USER='thisuser' [cite: 96]
[cite_start]DB_PASSWORD='xxxxxyyyy123!' [cite: 97]
[cite_start]DB_NAME='b4web' [cite: 98]
[cite_start]APP_DOMAIN='localhost' [cite: 99]
[cite_start]DB_PORT=5432 [cite: 100]
[cite_start]APP_PORT=8000 [cite: 101]
[cite_start]DB_DATA_PATH=b4web_db_data [cite: 102]
[cite_start]admin_user='pippoAdmin' [cite: 103]
[cite_start]admin_pass='pippoPW' [cite: 104]
[cite_start]admin_email='pippo.disney@topolina.com' [cite: 105]
[cite_start]SECRET_KEY='PIPPO_SECRET_KEY' [cite: 106]
[cite_start]ALGORITHM='HS256' [cite: 107]
[cite_start]SMTP_SERVER='smtp.disney.com' [cite: 108]
[cite_start]SMTP_PORT=313 [cite: 109]
[cite_start]SMTP_USERNAME='disney-mail.blablablabla-0123456-yumyum' [cite: 110]
[cite_start]SMTP_PASSWORD='plutoPW' [cite: 111]
[cite_start]EMAIL_SENDER='DoNotReply@mailsend.disney.com' [cite: 112]
[cite_start]ALLOWED_ORIGINS=http://localhost:3000 [cite: 113]
[cite_start]EXTTERNAL_ML_DATA_PATH='./external_ml_data' [cite: 114]</pre>

            [cite_start]<h3 id="esecuzione-locale">â–¶ï¸ Esecuzione in locale [cite: 115]</h3>
            [cite_start]<p>Per eseguire il backend localmente in ambiente di sviluppo[cite: 116]:</p>
            [cite_start]<pre>uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --env-file .env [cite: 117]</pre>

            [cite_start]<h3 id="docker">ğŸ³ Installazione su Docker [cite: 118]</h3>
            [cite_start]<p>Per avviare il servizio con Docker[cite: 119]:</p>
            [cite_start]<pre>docker-compose up --build -d [cite: 120]</pre>
            [cite_start]<p>Per fermare il servizio[cite: 121]:</p>
            [cite_start]<pre>docker-compose down [cite: 122]</pre>

            [cite_start]<h3 id="kubernetes">â˜¸ï¸ Installazione su Kubernetes [cite: 123]</h3>
            [cite_start]<p>Richiede cluster Kubernetes attivo e configurato con accesso a **Secrets**, **PVC**, e **Image Registry**[cite: 124].</p>

            <h4 id="namespace">1. [cite_start]Namespace [cite: 125]</h4>
            [cite_start]<p>Assicurati che il namespace `b4web` esista[cite: 126]:</p>
            [cite_start]<pre>kubectl create namespace b4web [cite: 127]</pre>

            <h4 id="secrets">2. [cite_start]Secrets [cite: 128]</h4>
            [cite_start]<p>I segreti sensibili (password, token, ecc.) sono montati da `SecretProviderClass` tramite CSI driver[cite: 129].</p>
            <p>**Esempio:**</p>
            [cite_start]<pre># b4web-env-secrets.yaml [cite: 131]
[cite_start]apiVersion: v1 [cite: 132]
[cite_start]kind: Secret [cite: 133]
[cite_start]metadata: [cite: 134]
  [cite_start]name: b4web-env-secrets [cite: 135]
  [cite_start]namespace: b4web [cite: 136]
[cite_start]type: Opaque [cite: 137]
[cite_start]stringData: [cite: 138]
  [cite_start]db-password: "xxxxyyyy123!" [cite: 139]
  [cite_start]admin-pass: "pippoPW" [cite: 140]
  [cite_start]smtp-password: "plutoPW" [cite: 141]
  [cite_start]secret-key: "PIPPO_SECRET_KEY" [cite: 142]</pre>
            <div class="warning">
                [cite_start]**âš ï¸ Attenzione:** Montato su `/mnt/secrets-store` in `deployment.yml`[cite: 143].
            </div>

            <h4 id="deployment">3. [cite_start]Deployment [cite: 144]</h4>
            [cite_start]<p>Serve per avviare, aggiornare e mantenere in esecuzione una o piÃ¹ repliche di unâ€™applicazione containerizzata, in questo caso lâ€™API chiamata `b4web-api`[cite: 145].</p>
            [cite_start]<p>Il file `deployment.yml` definisce lâ€™app[cite: 146]:</p>
            [cite_start]<pre>kubectl apply -f deployment.yml [cite: 147]</pre>
            [cite_start]<p>Contiene[cite: 148]:</p>
            <ul>
                [cite_start]<li>1 replica dellâ€™app [cite: 148]</li>
                [cite_start]<li>Immagine `inserire_la_tua_immagine_docker` [cite: 148]</li>
                [cite_start]<li>Montaggio secrets tramite CSI [cite: 148]</li>
                [cite_start]<li>Variabili dâ€™ambiente per connessione a DB, SMTP, ecc. [cite: 148]</li>
            </ul>

            <h4 id="service">4. [cite_start]Service [cite: 149]</h4>
            [cite_start]<p>Questo file definisce un oggetto Kubernetes di tipo **Service** per lâ€™applicazione `b4web-api`[cite: 150]. Serve per:</p>
            <ul>
                [cite_start]<li>esporre la porta dellâ€™applicazione allâ€™interno del cluster[cite: 151],</li>
                [cite_start]<li>astrarre lâ€™accesso ai pod dietro un nome DNS stabile[cite: 152],</li>
                [cite_start]<li>permettere la comunicazione tra servizi Kubernetes (es. da un altro pod)[cite: 153].</li>
            </ul>
            [cite_start]<p>Espone il backend allâ€™interno del cluster[cite: 154]:</p>
            [cite_start]<pre>kubectl apply -f service.yml [cite: 155]</pre>
            [cite_start]<p>Crea un punto di accesso stabile (**ClusterIP**) verso i pod gestiti dal deployment[cite: 156].</p>
            [cite_start]<p>Permette al traffico interno al cluster di raggiungere lâ€™API `b4web-api` attraverso lâ€™indirizzo[cite: 157]:</p>
            [cite_start]<pre>http://b4web-api.b4web.svc.cluster.local:8000 [cite: 158]</pre>
            [cite_start]<p>Rende possibile **scalare i pod** (es. 2, 3, 10) senza dover conoscere i singoli IP: il Service gestisce il bilanciamento[cite: 159].</p>
            <p>**âœ… Schema del flusso:**</p>
            <ol>
                [cite_start]<li>Richiesta dal cluster [cite: 161]</li>
                <li>â†“</li>
                [cite_start]<li>Service: `b4web-api` (porta 8000) [cite: 163]</li>
                <li>â†“</li>
                [cite_start]<li>Instrada ai pod con label `app=b4web-api` [cite: 165]</li>
                <li>â†“</li>
                [cite_start]<li>Container che ascolta su targetPort: 8000 [cite: 167]</li>
            </ol>

            <h4 id="accesso">5. [cite_start]Accesso [cite: 168]</h4>
            [cite_start]<p>In ambiente cloud (es. AKS), abbina un **Ingress Controller** o un **LoadBalancer** per rendere disponibile il servizio allâ€™esterno[cite: 169].</p>
            [cite_start]<p>Settare il valore di `APP_DOMAIN` per lâ€™ambiente Kubernetes ad esempio[cite: 170]:</p>
            [cite_start]<pre>https://b4web-api.neodatagroup.ai [cite: 171]</pre>
            [cite_start]<p>Allâ€™avvio il sistema produrrÃ  uno **SWAGGER** con la descrizione degli endpoint, ad esempio[cite: 172]:</p>
            [cite_start]<pre>https://b4web-api.neodatagroup.ai/docs#/ [cite: 173]</pre>
            [cite_start]<p>Settare il valore `ALLOWED_ORIGINS` per evitare problemi di **CORS**[cite: 174].</p>

            <hr/>

            [cite_start]<h2 id="avvio-server">ğŸš€ ALLâ€™AVVIO DEL SERVER [cite: 175]</h2>
            [cite_start]<p>Quando esegui `main.py`, **FastAPI** avvia lâ€™app seguendo questi passaggi[cite: 176]:</p>
            <ol>
                <li>**1. [cite_start]Creazione dellâ€™app FastAPI** [cite: 177]
                    [cite_start]<pre>app = FastAPI() [cite: 178]</pre>
                </li>
                <li>**2. [cite_start]Caricamento variabili dâ€™ambiente** [cite: 179]
                    [cite_start]<pre>load_dotenv() [cite: 180]</pre>
                    [cite_start]Carica `.env` e recupera le origini consentite per il CORS[cite: 182].
                </li>
                <li>**3. [cite_start]Configurazione CORS** [cite: 183]
                    [cite_start]<pre>app.add_middleware(CORSMiddleware, ...) [cite: 184]</pre>
                    [cite_start]Permette a frontend (es. React) su `localhost:3000` o domini configurati di comunicare con lâ€™API[cite: 185].
                </li>
                <li>**4. [cite_start]Registrazione dei router** [cite: 186]
                    [cite_start]<pre>app.include_router(...) # utenti, dati, connettori [cite: 187]</pre>
                    [cite_start]Collega i moduli che gestiscono[cite: 188]:
                    <ul>
                        [cite_start]<li>`/users` â†’ autenticazione, gestione utenti [cite: 189]</li>
                        [cite_start]<li>`/data` â†’ operazioni sul database locale (metaboliti, specie, spettrometria) [cite: 190]</li>
                        [cite_start]<li>`/conn/pubchem` â†’ integrazione esterna con PubChem [cite: 191]</li>
                        [cite_start]<li>`/conn/excel` â†’ caricamento dati da file Excel [cite: 192]</li>
                    </ul>
                </li>
                <li>**5. [cite_start]Avvio del server** [cite: 193]
                    [cite_start]<pre>if __name__ == "__main__": [cite: 194]
    [cite_start]uvicorn.run(app, host="0.0.0.0", port=8000) [cite: 195]</pre>
                    [cite_start]Avvia il server FastAPI con Uvicorn, ascoltando sulla porta 8000[cite: 196].
                </li>
            </ol>

            <hr/>

            [cite_start]<h2 id="descrizione-file">ğŸ§© Descrizione dei file [cite: 197]</h2>

            [cite_start]<h3 id="main-models">ğŸ“„ `main.py` & `models.py` [cite: 198]</h3>
            <ul>
                [cite_start]<li>Il **`main.py`** Ã¨ il punto dâ€™ingresso dellâ€™applicazione FastAPI[cite: 199]. [cite_start]Registra middleware, include i router, carica lâ€™ambiente e avvia il server[cite: 200].</li>
                [cite_start]<li>Il **`models.py`** contiene **tutte le tabelle del database**, mappate con **SQLAlchemy ORM**[cite: 201]. [cite_start]Queste classi sono la base per query ORM e usate in tutte le operazioni con il DB[cite: 202].
                    <ul>
                        [cite_start]<li>**Autenticazione**: `User`, `OTP` [cite: 201]</li>
                        [cite_start]<li>**Struttura biologica**: `Taxonomy`, `Sample`, `BiologicalReplicate` [cite: 201]</li>
                        [cite_start]<li>**Dati metabolomici**: `Metabolite`, `ExperimentalMetabolite`, `Spectrometry` [cite: 201]</li>
                        [cite_start]<li>**Dati PubChem/biochimici**: `Bioassay`, `Substance`, `MetaboliteBioassay`, `Bioactivity`, `BioactivityClass`, `BioassayClass`, `CompoundClass` [cite: 201]</li>
                        [cite_start]<li>**Altro**: `Province`, `Municipality`, `Setting`, `MolecularClass`, `MolecularFormula`, `MolecularStructure`, `ResearchGroup` [cite: 201]</li>
                    </ul>
                </li>
            </ul>

            [cite_start]<h3 id="settings">ğŸ“„ `settings.py` [cite: 203]</h3>
            [cite_start]<p>Classe `Config` che legge e centralizza le **variabili di configurazione ambientale** (es. `DB_HOST`, `DB_USER`, `DB_PASSWORD`)[cite: 204]. [cite_start]Ãˆ utilizzato da `database_session.py` per creare la connessione al database[cite: 204].</p>

            [cite_start]<h3 id="database-session">ğŸ“„ `database_session.py` [cite: 205]</h3>
            [cite_start]<p>Gestisce la **connessione al database PostgreSQL**[cite: 206]. [cite_start]Crea un `SessionLocal` tramite SQLAlchemy [cite: 207] [cite_start]ed espone la funzione **`get_db()`** per usarla nei router via `Depends(get_db)`[cite: 208, 209].</p>

            [cite_start]<h3 id="tableparams">ğŸ“„ `tableparams.py` [cite: 210]</h3>
            [cite_start]<p>Definisce classi Python che rappresentano **dati in ingresso** da form, JSON o chiamate esterne[cite: 211]. [cite_start]Questi oggetti sono spesso usati per validare e passare dati ai metodi dei moduli `insert_*`[cite: 213].</p>
            <ul>
                [cite_start]<li>`MetaboliteParams`, `ExperimentalMetaboliteParams` â†’ usati per costruire record da inserire [cite: 212]</li>
                [cite_start]<li>`BioassayParams`, `TaxonomyParams`, `SubstanceParams` â†’ dati provenienti da PubChem [cite: 212]</li>
                [cite_start]<li>`UserParams` â†’ gestione utenti [cite: 212]</li>
            </ul>

            [cite_start]<h3 id="come-interagiscono">ğŸ”„ Come interagiscono [cite: 214]</h3>
            <ol>
                [cite_start]<li>`main.py` â†’ avvia il server FastAPI [cite: 216]</li>
                [cite_start]<li>`settings.py` â†’ legge configurazioni ambiente [cite: 217]</li>
                [cite_start]<li>`database_session.py` â†’ apre connessione DB [cite: 218]</li>
                [cite_start]<li>`models.py` â†’ definisce le tabelle su cui operano gli endpoint [cite: 219]</li>
                [cite_start]<li>`tableparams.py` â†’ costruisce oggetti input da request/form [cite: 220]</li>
                [cite_start]<li>`/routers` (APIusers, APIdata, APIconnector) â†’ definiscono le rotte [cite: 221]</li>
                [cite_start]<li>`/connectors` e `/datamanager` â†’ logiche di elaborazione dati [cite: 222]</li>
                [cite_start]<li>`/usermanager` â†’ gestione utenti e autenticazione [cite: 223]</li>
            </ol>

            <hr/>

            [cite_start]<h2 id="usermanager">ğŸ‘¤ usermanager [cite: 224]</h2>
            [cite_start]<p>Questo modulo contiene lâ€™implementazione delle API per la **gestione degli utenti** della piattaforma[cite: 225]. [cite_start]Le funzionalitÃ  includono autenticazione, OTP, gestione password, creazione/verifica utente e operazioni amministrative[cite: 226].</p>

            [cite_start]<h4>Flusso completo di registrazione e login [cite: 230]</h4>
            <ol>
                [cite_start]<li>Creazione utente (**superuser**) â†’ `/create_user` [cite: 231]</li>
                [cite_start]<li>Verifica email (utente) â†’ `/verify_email?check=...` [cite: 232]</li>
                [cite_start]<li>Richiesta OTP (utente) â†’ `/request_access` [cite: 233]</li>
                [cite_start]<li>Login (utente) â†’ `/login` â†’ Ottieni **`access_token` JWT** per autenticazioni future [cite: 234]</li>
                [cite_start]<li>Cambia password â†’ `/change_pasword` [cite: 235]</li>
                [cite_start]<li>Password dimenticata â†’ `/reset_password` [cite: 236]</li>
            </ol>
            [cite_start]<p>Il flusso di autenticazione Ã¨ **two-factor (2FA)** basato su password e OTP via email[cite: 241]. [cite_start]Gli OTP sono criptati con JWT, memorizzati su DB e verificati lato server[cite: 240].</p>

            [cite_start]<h3 id="endpoints-users">ğŸŒ Endpoint `APIusers.py` [cite: 246]</h3>
            [cite_start]<p>Il file si occupa di tutte le operazioni fondamentali legate al ciclo di vita di un utente [cite: 248][cite_start], utilizzando **modelli Pydantic**, **SQLAlchemy** e **JWT**[cite: 249]. [cite_start]L'endpoint Ã¨ richiamato nel `main.py` con il prefisso `/users`[cite: 254].</p>

            [cite_start]<h4>ğŸ” Autenticazione e Accesso [cite: 255]</h4>
            <ul>
                [cite_start]<li>**Richiesta OTP (`/request_access` [POST])**: Verifica credenziali e invia un OTP via email[cite: 256, 259, 260].
                    <ul>
                        [cite_start]<li>**Funzioni usate**: `generate_otp()`, `store_otp_in_db()`, `send_otp_email()`[cite: 262, 263, 264, 265].</li>
                    </ul>
                </li>
                [cite_start]<li>**Login (`/login` [POST])**: Login tramite username, password e OTP[cite: 257, 267].
                    <ul>
                        [cite_start]<li>**Processo**: Verifica credenziali e OTP usando `verify_otp_from_db()`[cite: 271, 272]. [cite_start]Ritorna `LoginResponse` con **token JWT** generato tramite `create_access_token(user)`[cite: 274].</li>
                    </ul>
                </li>
            </ul>

            [cite_start]<h4>ğŸ” Gestione Password [cite: 275]</h4>
            <ul>
                [cite_start]<li>**Cambio Password (`/change_password` [POST])**: Richiede la vecchia password[cite: 276, 279]. [cite_start]Richiede autenticazione via token[cite: 281].</li>
                [cite_start]<li>**Reset Password (`/reset_password` [POST])**: Reset tramite username ed email, con conferma via email[cite: 277, 284].
                    <ul>
                        [cite_start]<li>**Processo**: Verifica username + email, imposta nuova password, imposta `checked = False` e invia una mail di verifica[cite: 287, 288].</li>
                    </ul>
                </li>
            </ul>

            [cite_start]<h4>ğŸ‘¤ Gestione Utenti [cite: 289]</h4>
            <ul>
                [cite_start]<li>**Creazione Utente (`/create_user` [POST])**: Solo per **superuser**[cite: 290, 298]. [cite_start]Invia email di verifica (`send_verification_email()`)[cite: 290, 302].</li>
                [cite_start]<li>**Verifica Email (`/verify_email` [GET])**: Attiva lâ€™account tramite token di conferma in URL (`check=...`)[cite: 291, 305]. [cite_start]Imposta `user.checked = True`[cite: 307].</li>
                [cite_start]<li>**Elenco Utenti (`/get_list` [GET])**: Lista utenti con paginazione (default: `page=1`, `limit=10`)[cite: 292, 309, 311, 312]. [cite_start]**Solo superuser**[cite: 292, 313].</li>
                [cite_start]<li>**Cancellazione (`/delete/{user_id}` [DELETE])**: Elimina un utente[cite: 293, 316]. [cite_start]**Solo superuser**[cite: 293, 317].</li>
                [cite_start]<li>**Cambio Ruolo (`/change_role` [PUT])**: Modifica ruolo utente[cite: 294, 319]. [cite_start]**Solo superuser**[cite: 294, 321].</li>
            </ul>

            [cite_start]<h4>ğŸ” Altri elementi chiave [cite: 322]</h4>
            <ul>
                [cite_start]<li>**JWT**: Usato per autenticazione e OTP (encode, decode)[cite: 323].</li>
                [cite_start]<li>**Modelli Pydantic**: Per validazione dati[cite: 324].</li>
                [cite_start]<li>**SMTP/Email**: Invio via `aiosmtplib` per OTP e verifica, configurabile via variabili dâ€™ambiente[cite: 325].</li>
                [cite_start]<li>**Ruoli gestiti con enum**: `superuser`, `guest`, `visitor`, `analyst`[cite: 326].</li>
            </ul>

            [cite_start]<h3 id="esempi-users">ğŸš€ Esempi di utilizzo degli endpoint [cite: 327]</h3>
            <p>Esempi di richieste e risposte per la gestione utenti:</p>
            <details>
                <summary>1. Creazione utente (/create_user)</summary>
                [cite_start]<pre>POST /create_user [cite: 329]
[cite_start]Authorization: Bearer &lt;token_superuser&gt; [cite: 330]
[cite_start]{ [cite: 331]
[cite_start]"username": "mario", [cite: 332]
[cite_start]"email": "mario@esempio.com", [cite: 333]
[cite_start]"password": "password123", [cite: 334]
[cite_start]"type": "guest" [cite: 335]
[cite_start]} [cite: 336]
Risposta:
[cite_start]{ [cite: 338]
[cite_start]"message": "User created successfully. Verification email sent.", [cite: 339]
[cite_start]"username": "mario", [cite: 340]
[cite_start]"type": "guest" [cite: 341]
}</pre>
            </details>
            <details>
                <summary>2. Verifica email (/verify_email)</summary>
                <p>URL da email:</p>
                [cite_start]<pre>GET /verify_email?check=&lt;token&gt; [cite: 344]
Risposta:
[cite_start]{ [cite: 346]
[cite_start]"message": "Email verified successfully.", [cite: 347]
[cite_start]"email": "mario@esempio.com" [cite: 348]
}</pre>
            </details>
            <details>
                <summary>3. Richiesta OTP (/request_access)</summary>
                [cite_start]<pre>POST /request_access [cite: 351]
[cite_start]{ [cite: 352]
[cite_start]"username": "mario", [cite: 353]
[cite_start]"password": "password123" [cite: 354]
[cite_start]} [cite: 355]
Risposta:
[cite_start]{ [cite: 357]
[cite_start]"message": "OTP sent to registered email" [cite: 358]
}</pre>
            </details>
            <details>
                <summary>4. Login con OTP (/login)</summary>
                [cite_start]<pre>POST /login [cite: 361]
[cite_start]{ [cite: 362]
[cite_start]"username": "mario", [cite: 363]
[cite_start]"password": "password123", [cite: 364]
[cite_start]"otp": "123456" [cite: 365]
[cite_start]} [cite: 366]
Risposta:
[cite_start]{ [cite: 368]
[cite_start]"access_token": "&lt;JWT_TOKEN&gt;", [cite: 369]
[cite_start]"token_type": "bearer", [cite: 370]
[cite_start]"user_type": "guest" [cite: 371]
}</pre>
            </details>
            <details>
                <summary>5. Cambio password (/change_password)</summary>
                [cite_start]<pre>POST /change_password [cite: 374]
[cite_start]Authorization: Bearer &lt;JWT_TOKEN&gt; [cite: 375]
[cite_start]{ [cite: 376]
[cite_start]"username": "mario", [cite: 377]
[cite_start]"old_password": "password123", [cite: 378]
[cite_start]"new_password": "nuovaPassword" [cite: 379]
[cite_start]} [cite: 380]</pre>
            </details>
            <details>
                <summary>6. Reset password (/reset_password)</summary>
                [cite_start]<pre>POST /reset_password [cite: 382]
[cite_start]{ [cite: 383]
[cite_start]"username": "mario", [cite: 384]
[cite_start]"email": "mario@esempio.com", [cite: 385]
[cite_start]"new_password": "passwordReset" [cite: 386]
[cite_start]} [cite: 387]</pre>
                [cite_start]<p>InvierÃ  una nuova email di verifica allâ€™utente[cite: 388].</p>
            </details>
            <details>
                <summary>7. Elenco utenti (/get_list)</summary>
                [cite_start]<pre>GET /get_list?page=1&limit=10 [cite: 390]
[cite_start]Authorization: Bearer &lt;token_superuser&gt; [cite: 391]</pre>
            </details>
            <details>
                <summary>8. Cancellazione utente (/delete/{user_id})</summary>
                [cite_start]<pre>DELETE /delete/5 [cite: 393]
[cite_start]Authorization: Bearer &lt;token_superuser&gt; [cite: 394]</pre>
            </details>
            <details>
                <summary>9. Modifica ruolo utente (/change_role)</summary>
                [cite_start]<pre>PUT /change_role [cite: 396]
[cite_start]Authorization: Bearer &lt;token_superuser&gt; [cite: 397]
[cite_start]{ [cite: 398]
[cite_start]"user_id": 5, [cite: 399]
[cite_start]"new_role": "analyst" [cite: 400]
[cite_start]} [cite: 401]</pre>
            </details>

            [cite_start]<h3 id="tasks">ğŸ“ Script `background_tasks.py` [cite: 402]</h3>
            [cite_start]<p>Script ausiliario per la **pulizia automatica degli OTP scaduti o usati**[cite: 403].</p>
            <ul>
                [cite_start]<li>`cleanup_expired_otps(db)`: Cancella gli OTP scaduti o giÃ  utilizzati (oltre i 5 minuti)[cite: 405].</li>
                [cite_start]<li>`schedule_cleanup()`: Avvia un ciclo infinito che esegue `cleanup_expired_otps` ogni 5 minuti[cite: 406].</li>
            </ul>

            [cite_start]<h3 id="scheduler">ğŸ“ Script `scheduler.py` [cite: 408]</h3>
            [cite_start]<p>Script per schedulare automaticamente la **pulizia periodica degli OTP** ogni 5 minuti utilizzando **APScheduler**[cite: 409, 413]. [cite_start]Utilizza `AsyncIOScheduler` per avviare un job asincrono[cite: 411].</p>

            <hr/>

            [cite_start]<h2 id="datamanager">ğŸ“¦ datamanager [cite: 414]</h2>
            [cite_start]<p>Il modulo gestisce lâ€™inserimento, la trasformazione, la consultazione e lâ€™aggiornamento dei dati relativi ai **metaboliti**, **spettrometria** e dettagli associati alle **specie biologiche**[cite: 415].</p>

            [cite_start]<h3 id="endpoints-data">ğŸŒ Endpoint `APIdata.py` [cite: 416]</h3>
            [cite_start]<p>Implementa diverse API dedicate alla gestione dei dati, fungendo da controller per il frontend[cite: 417]. [cite_start]Espone endpoint per l'inserimento, la consultazione e utility per recuperare opzioni e metadati[cite: 418].</p>
            [cite_start]<p>L'endpoint Ã¨ montato in `main.py` con il prefisso `/data`[cite: 428].</p>

            [cite_start]<h4>ğŸ§± Modelli (Request & Response) [cite: 429]</h4>
            [cite_start]<p>Strutture dati (Pydantic) usate dagli endpoint[cite: 430]:</p>
            <ul>
                [cite_start]<li>`MetaboliteModel`: Inserimento di un metabolita[cite: 431].</li>
                [cite_start]<li>`SpectrometryRequestModel`: Inserimento di uno spettro[cite: 432].</li>
                [cite_start]<li>`MetaboliteDetailResponse`: Dettagli completi su un metabolita[cite: 437].</li>
                [cite_start]<li>`TaxonomyDetailResponse`: Tassonomia con metaboliti sperimentali associati[cite: 438].</li>
                [cite_start]<li>`FormulaRTResponse`: Risposta per ricerche con formula molecolare e/o RT[cite: 440].</li>
                [cite_start]<li>Modelli per Bioactivity, Bioassay, Replicati Biologici e Dettagli Geografici[cite: 443, 444].</li>
            </ul>

            [cite_start]<h4>âš™ï¸ Funzioni interne (logiche) [cite: 473]</h4>
            [cite_start]<p>Le funzioni utilizzate negli endpoint provengono da moduli come[cite: 474]:</p>
            <ul>
                [cite_start]<li>`InsertMetaboliteLogic` (logica per inserimento/metaboliti) [cite: 475]</li>
                [cite_start]<li>`InsertSpectrometryLogic` (logica per spettrometria) [cite: 476]</li>
                [cite_start]<li>`InsertTaxonomyLogic` (logica per tassonomia) [cite: 477]</li>
                [cite_start]<li>`InsertBioactivityLogic` (logica per lâ€™inserimento di bioactivity) [cite: 478]</li>
                [cite_start]<li>`FragmentedMetabolites` e metodi `*_data_manipulation` (elaborazione dati/risposte dettagliate) [cite: 479, 480]</li>
            </ul>

            [cite_start]<h4>ğŸš€ Endpoint Data Manager [cite: 484]</h4>
            [cite_start]<p>Ogni endpoint Ã¨ protetto da autenticazione e gestisce accesso differenziato in base al ruolo utente[cite: 485].</p>
            <details>
                <summary>ğŸ” Ricerca Metaboliti</summary>
                <ul>
                    [cite_start]<li>`GET /get_all_metabolites` â†’ lista di tutti i metaboliti [cite: 486]</li>
                    [cite_start]<li>`GET /get_metabolite` â†’ cerca metabolita per nome (parziale) [cite: 487]</li>
                    [cite_start]<li>`GET /data/metabolite_synonyms` â†’ cerca i metaboliti per sinonimo [cite: 488]</li>
                </ul>
            </details>
            <details>
                <summary>ğŸ§ª Gestione Spettrometria</summary>
                <ul>
                    [cite_start]<li>`GET /get_spectrometry/{id}` â†’ imposta adducts e settings [cite: 489]</li>
                    [cite_start]<li>`POST /add_spectrometry` â†’ inserisce dati spettrometrici [cite: 490, 496]</li>
                    [cite_start]<li>`DELETE /data/delete_spectrometry/{id}` â†’ elimina una spettrometria [cite: 491]</li>
                    [cite_start]<li>`GET /data/get_all_spectrometries` â†’ recupera la lista della spettrometria con paginazione [cite: 492]</li>
                </ul>
            </details>
            <details>
                <summary>â• Inserimento Metaboliti</summary>
                <ul>
                    [cite_start]<li>`POST /add_metabolite` â†’ inserisce o aggiorna un metabolita [cite: 498]</li>
                </ul>
            </details>
            <details>
                <summary>ğŸ§¬ Ricerca e Gestione Tassonomica</summary>
                <ul>
                    [cite_start]<li>`GET /get_all_species`, `GET /get_specie` (per nome scientifico), `GET /get_all_genera`, `GET /get_all_families` [cite: 499, 500, 501, 503]</li>
                    [cite_start]<li>`DELETE /data/delete_taxonomy/{id_taxa}` â†’ elimina una tassonomia (eliminazione a cascata) [cite: 506]</li>
                    [cite_start]<li>`POST /data/add_taxonomy`, `PUT /data/update_taxonomy` [cite: 509, 510]</li>
                </ul>
            </details>
            <details>
                <summary>ğŸ“‹ Dettaglio</summary>
                <ul>
                    [cite_start]<li>`GET /metabolite_detail` â†’ dettaglio completo metabolita [cite: 511]</li>
                    [cite_start]<li>`GET /taxonomy_detail` â†’ dettaglio completo tassonomia [cite: 512]</li>
                </ul>
            </details>
            <details>
                <summary>ğŸ§­ Ricerca per Dati Sperimentali</summary>
                <ul>
                    [cite_start]<li>`GET /search_metabolite_by_experimental_mz` â†’ ricerca per m/z sperimentale e finestra di errore [cite: 514]</li>
                    [cite_start]<li>`GET /search_metabolite_by_formula_rt` â†’ ricerca per formula molecolare e/o RT [cite: 516]</li>
                    [cite_start]<li>`GET /search_metabolite_by_fragments` â†’ ricerca per frammenti e finestra di errore [cite: 520]</li>
                </ul>
            </details>
            <details>
                <summary>ğŸ§« Gestione Bioactivity e Classi/Replicati</summary>
                <ul>
                    [cite_start]<li>`POST /data/add_bioactivity`, `PUT /data/update_bioactivity/{id}`, `DELETE /data/delete_bioactivity/{id}` [cite: 528, 529, 530]</li>
                    [cite_start]<li>Endpoint per `BioactivityClass` e `BioassayClass` (Add/Update/Delete/Get All) [cite: 532, 536]</li>
                    [cite_start]<li>`POST /data/add_biological_replicate`, `DELETE /data/delete_biological_replicate` [cite: 540, 541]</li>
                </ul>
            </details>

            [cite_start]<h3 id="insert-metabolite">ğŸ“ Script `insert_metabolite.py` [cite: 565]</h3>
            [cite_start]<p>Gestisce lâ€™inserimento e la manipolazione dei dati relativi ai metaboliti[cite: 566].</p>

            [cite_start]<h4>Procedura ETL [cite: 568]</h4>
            <p>**ğŸŸ¢ Extract**</p>
            <ul>
                [cite_start]<li>Estrazione dei dati dal JSON tramite `load_bioassay(json_string)` e `load_substance(json_string, compound_name)`[cite: 569, 570].</li>
            </ul>
            <p>**ğŸ”µ Transform**</p>
            <ul>
                [cite_start]<li>Le funzioni di estrazione convertono i dati JSON in oggetti `BioassayParams` e `SubstanceParams`[cite: 571].</li>
                [cite_start]<li>`metaboliteinsert_data_manipulation(form_data, db)` trasforma i dati del modulo in oggetti da inserire, gestendo anche la conversione di immagini in dati binari[cite: 572].</li>
            </ul>
            <p>**ğŸ”´ Load**</p>
            <ul>
                [cite_start]<li>Inserimento di nuovi metaboliti, strutture molecolari, bioassay, metabolite bioassay, sostanze, impostazioni, campioni, replicati biologici e metaboliti sperimentali nel database[cite: 573, 574, 575, 576, 577, 578, 579, 580].</li>
            </ul>

            [cite_start]<h4>ğŸ› ï¸ Metodo `metaboliteinsert_data_manipulation` [cite: 601]</h4>
            [cite_start]<p>Metodo core che gestisce lâ€™inserimento dei dati dei metaboliti nel database[cite: 602, 603]. [cite_start]Gestisce l'estrazione, la trasformazione (es. conversione immagine 2D in binario) [cite: 611] [cite_start]e il caricamento di tutte le entitÃ  correlate (strutture molecolari, bioassay, campioni, replicati ecc.)[cite: 616, 623, 628, 630]. [cite_start]Include la gestione delle eccezioni e il **rollback della transazione** in caso di errore[cite: 605].</p>

            [cite_start]<h4>ğŸ§© Classe `BioactivityLoading` [cite: 634]</h4>
            [cite_start]<p>Responsabile del recupero e della trasformazione dei dati **biochimici** (bioassay) e **chimici** (substances) da risposte JSON, tipicamente da PubChem[cite: 635]. [cite_start]Agisce come utilitÃ  di parsing[cite: 637].</p>
            <ul>
                [cite_start]<li>`load_bioassay(json_string: str)`: Elabora i dati relativi ai test biochimici (AID, titolo, tipo, descrizione) dal JSON e li raggruppa in un oggetto `BioassayParams`[cite: 638, 642, 643].</li>
                [cite_start]<li>`load_substance(json_string: str, compound_name: str)`: Elabora le informazioni chimiche (numero di registrazione, nome IUPAC, nome commerciale) e le organizza in un oggetto `SubstanceParams`[cite: 646, 650, 651].</li>
            </ul>

            [cite_start]<h3 id="insert-spectrometry">ğŸ“ Script `insert_spectrometry.py` [cite: 654]</h3>
            [cite_start]<p>Gestisce lâ€™inserimento dei dati di **spettrometria LC-MS** (grafici, picchi, parametri strumentali)[cite: 655].</p>

            [cite_start]<h4>Procedura ETL [cite: 657]</h4>
            [cite_start]<p>**ğŸŸ¢ Extract**: Ricezione di `intensity_threshold`, `filtered_peaks`, `image_base64` (opzionale), parametri strumentali e `metabolite_name`[cite: 659, 660, 661, 662, 663].</p>
            [cite_start]<p>**ğŸ”µ Transform**: Se non fornita, generazione automatica del grafico dello spettro a partire dai picchi (`filtered_peaks`) e conversione in base64[cite: 666]. [cite_start]Conversione dati numerici e preparazione della struttura dati[cite: 667].</p>
            [cite_start]<p>**ğŸ”´ Load**: Inserimento di un nuovo record nella tabella **Spectrometry**, associando i dati al metabolita e al setting strumentale[cite: 670].</p>

            [cite_start]<h4>ğŸ§© Classe `InsertSpectrometryLogic` [cite: 674]</h4>
            [cite_start]<p>Classe principale per elaborare e caricare i dati spettrometrici[cite: 675].</p>
            <ul>
                [cite_start]<li>`create_graph_base64(filtered_peaks)`: Genera un grafico dello spettro in formato base64[cite: 678].</li>
                [cite_start]<li>`insert_spectrometry_data(data, db: Session)`: Gestisce lâ€™intero flusso di inserimento, dalla validazione alla creazione del grafico, fino al salvataggio nel database[cite: 679].</li>
            </ul>

            [cite_start]<h3 id="insert-taxonomy">ğŸ“ Script `insert_taxonomy.py` [cite: 683]</h3>
            [cite_start]<p>Gestisce l'inserimento, aggiornamento, eliminazione e recupero di **tassonomie** e **campioni**[cite: 684].</p>

            [cite_start]<h4>Procedura ETL [cite: 686]</h4>
            <p>**ğŸŸ¢ Extract**: Dati di tassonomie e campioni ricevuti da API o form. [cite_start]Possibile recupero automatico da PubChem per dati tassonomici mancanti[cite: 688, 690].</p>
            [cite_start]<p>**ğŸ”µ Transform**: Validazione, conversione date e verifica dei riferimenti a entitÃ  collegate (comuni o tassonomie)[cite: 692, 693].</p>
            [cite_start]<p>**ğŸ”´ Load**: Inserimento, aggiornamento ed eliminazione di tassonomie e gestione dei campioni[cite: 697, 698, 700].</p>

            [cite_start]<h4>ğŸ§© Classe `InsertTaxonomyLogic` [cite: 701]</h4>
            [cite_start]<p>Implementa i metodi necessari per la gestione delle tassonomie e dei campioni[cite: 702].</p>
            <ul>
                [cite_start]<li>**Tassonomie**: `add_taxonomy`, `update_taxonomy`, `delete_taxonomy`[cite: 705, 706, 707].</li>
                [cite_start]<li>**Campioni**: `add_sample`, `update_sample`, `delete_sample`[cite: 711, 712, 713, 714].</li>
            </ul>

            [cite_start]<h3 id="metabolite-detail">ğŸ“ Script `metabolite_detail.py` [cite: 717]</h3>
            [cite_start]<p>Responsabile della generazione e aggregazione dei **dettagli completi relativi a un metabolita**[cite: 718]. [cite_start]Lavora su dati esistenti (non effettua inserimenti)[cite: 720].</p>

            [cite_start]<h4>Procedura ETL (interpretata come aggregazione) [cite: 721]</h4>
            [cite_start]<p>**ğŸŸ¢ Extract**: Interroga il DB per estrarre informazioni chimiche, bioassay, tassonomiche, frammenti sperimentali e spettri LC-MS[cite: 723].</p>
            [cite_start]<p>**ğŸ”µ Transform**: Trasforma i dati in dizionari Python strutturati e raggruppati (per specie o impostazione sperimentale)[cite: 725, 726].</p>
            [cite_start]<p>**ğŸ”´ Load**: Corrisponde alla preparazione di una **risposta aggregata**[cite: 729].</p>

            [cite_start]<h4>ğŸ› ï¸ Metodo `metabolitedetail_data_manipulation` [cite: 730]</h4>
            [cite_start]<p>Aggrega tutte le informazioni disponibili su un metabolita (formula, massa, bioassay, dati spettrometrici, tassonomici), organizzando frammenti e dati LC-MS per specie e configurazione strumentale[cite: 732, 733].</p>

            [cite_start]<h4>ğŸ§© Classe `FragmentedMetabolites` [cite: 742]</h4>
            <ul>
                [cite_start]<li>`get_fragmented_metabolites_by_name_species`: Raccoglie tutti i frammenti LC-MS registrati per un metabolita e una specie, con i relativi parametri sperimentali[cite: 744, 745].</li>
            </ul>

            [cite_start]<h4>ğŸ§© Classe `UpdateMetabolite` [cite: 749]</h4>
            <ul>
                [cite_start]<li>`update_metabolite_check(forms: dict, db: Session)`: Consente la modifica controllata dei dati di un metabolita (rinomina, formula, massa, parametri spettrometrici, ecc.), mantenendo l'integritÃ  delle relazioni[cite: 751, 752].</li>
            </ul>

            [cite_start]<h3 id="insert-bioactivity">ğŸ“ Script `insert_bioactivity.py` [cite: 753]</h3>
            [cite_start]<p>Garantisce lâ€™inserimento di un nuovo record di bioattivitÃ [cite: 754].</p>

            [cite_start]<h4>Procedura ETL [cite: 755]</h4>
            [cite_start]<p>**ğŸŸ¢ Extract**: Il dizionario dei dati fornito in input Ã¨ considerato il dato estratto[cite: 756].</p>
            [cite_start]<p>**ğŸ”µ Transform**: I metodi della classe interrogano il database per verificare lâ€™esistenza e creare, se necessario, i record correlati (`ResearchGroup`, `Taxonomy`, `Municipality`, `Sample`, `Setting`, `BiologicalReplicate`, `BioassayClass`, `BioactivityClass`)[cite: 757, 763, 766, 767, 769, 773, 776, 779, 783, 787].</p>
            [cite_start]<p>**ğŸ”´ Load**: Creazione e salvataggio del nuovo record **Bioactivity**[cite: 759, 792].</p>

            [cite_start]<h3 id="index-py">ğŸ“ Script `index.py` [cite: 63]</h3>
            [cite_start]<p>Script di **orchestrazione** che coordina le chiamate tra moduli e funge da punto dâ€™accesso/interfaccia di collegamento tra lâ€™utente e il backend logico[cite: 797, 799].</p>

            [cite_start]<h4>ğŸ” Metodi search [cite: 64, 802]</h4>
            [cite_start]<p>Metodi per la ricerca nella base dati[cite: 803]:</p>
            <ul>
                [cite_start]<li>`search_metabolites`, `search_species`, `search_all_genus`, `search_all_families`[cite: 804, 805, 806, 807].</li>
                [cite_start]<li>`search_metabolite`, `search_specie`, `search_genu`, `search_family`[cite: 808, 809, 811, 813].</li>
                [cite_start]<li>`search_experimental_mz`: Ricerca per m/z sperimentale, tipo (positivo/negativo) e finestra di errore[cite: 815].</li>
                [cite_start]<li>`search_formula_rt`: Ricerca tramite formula molecolare e/o valore RT[cite: 817, 818].</li>
                [cite_start]<li>`search_metabolites_by_fragments`: Ricerca attraverso frammenti, con definizione della finestra di ricerca e filtro per frammenti positivi/negativi[cite: 820, 821].</li>
            </ul>

            <hr/>

            [cite_start]<h2 id="connettori">ğŸ“¦ Connectors [cite: 823]</h2>
            [cite_start]<p>Modulo che permette di interagire con dati esterni, come quelli da **PubChem** e da **file Excel**[cite: 824]. [cite_start]Tutti gli endpoint sono protetti da autenticazione (`current_user`)[cite: 825].</p>

            [cite_start]<h3 id="connector-excel">Da file Excel [cite: 66]</h3>
            <p>API per l'importazione di dati da file Excel. [cite_start]Montate con prefisso `/conn/excel`[cite: 831].</p>
            [cite_start]<h4>ğŸš€ Endpoint Excel [cite: 832]</h4>
            <ul>
                [cite_start]<li>**`ğŸ§« POST /spectrometry_graph`**: Carica file Excel spettrometria, filtra i picchi in base a una soglia di intensitÃ  relativa (%BIC) e restituisce dati filtrati e grafico in base64[cite: 833, 834].</li>
                [cite_start]<li>**`ğŸ”¬ POST /add_bioactivity`**: Importa e inserisce dati di bioactivity da file Excel o CSV[cite: 854, 855].</li>
                [cite_start]<li>**`ğŸ”¬ POST /add_taxonomy_and_sample`**: Carica file Excel con dati di tassonomia e/o campioni, li valida e li inserisce[cite: 863, 864].</li>
                [cite_start]<li>**`ğŸ”¬ POST /add_experimental_metabolite`**: Carica file Excel o CSV con dati degli experimental metabolite (template ufficiale), li valida e li inserisce[cite: 874, 875].</li>
            </ul>

            [cite_start]<h3 id="connector-pubchem">Da PubChem [cite: 72]</h3>
            <p>API per l'importazione di dati da PubChem. [cite_start]Montate con prefisso `/conn/pubchem`[cite: 890].</p>
            [cite_start]<h4>ğŸš€ Endpoint PubChem [cite: 891]</h4>
            <ul>
                [cite_start]<li>**`ğŸ”¬ GET /get_metabolite_data`**: Dato il nome di un metabolita, ottiene da PubChem informazioni chimiche di base (formula molecolare, peso, SMILES, InChI)[cite: 892, 893].</li>
                [cite_start]<li>**`ğŸ§¬ GET /get_pubchem_taxonomy`**: Dato il nome di un organismo, restituisce lâ€™intera tassonomia PubChem[cite: 906, 907].</li>
                [cite_start]<li>**`ğŸ“– GET /get_pug_view_data`**: Restituisce il contenuto completo della pagina PUG-View di PubChem, dato il `cid` del composto[cite: 922, 923].</li>
                [cite_start]<li>**`ğŸ§ª GET /get_bioassays_from_cid`**: Ottiene tutti i bioassay associati a un metabolita da PubChem, usando il suo `cid`[cite: 930, 931].</li>
                [cite_start]<li>**`ğŸ“Š GET /get_bioassays_from_aid`**: Cerca i bioassay a partire dal nome del metabolita, prendendo gli AID dal database interno (`MetaboliteBioassay`) e recuperando i dettagli da PubChem[cite: 938].</li>
            </ul>

            <hr/>

            [cite_start]<h2 id="machine-learning">ğŸ“¦ machine_learning [cite: 964]</h2>
            [cite_start]<p>Modulo per elaborare in maniera avanzata le spettrometrie concentrandosi sulle **similaritÃ **[cite: 965].</p>

            [cite_start]<h3 id="endpoints-ml">ğŸŒ Endpoint `APImodel.py` [cite: 966]</h3>
            [cite_start]<p>Lâ€™endpoint permette di calcolare la **similaritÃ  tra spettri** forniti in input con spettri presenti nella base di dati di **MassBank**[cite: 968]. [cite_start]L'endpoint Ã¨ montato con prefisso `/ml`[cite: 973].</p>

            [cite_start]<h4>ğŸš€ Endpoint Machine Learning [cite: 979]</h4>
            [cite_start]<p>Protetti da autenticazione; utenti `visitor` o `guest` non hanno accesso[cite: 981].</p>
            <ul>
                <li>**`ğŸ§ª POST /ml/spectrum_match`**: Calcola la similaritÃ  dello spettro. [cite_start]Richiede `input_file` (JSON), `top_n`, `machine`, `ion_mode`, `compound_class`[cite: 982].</li>
            </ul>

            [cite_start]<h3 id="match-ms2">ğŸ“ Script `match_ms2.py` [cite: 984]</h3>
            [cite_start]<p>Contiene metodi per gestire il caricamento dello spettro e il calcolo della similaritÃ [cite: 985].</p>

            [cite_start]<h4>Procedura ETL [cite: 987]</h4>
            [cite_start]<p>**ğŸŸ¢ Extract**: Procedura effettuata in `load_spectra_from_json`[cite: 988]. [cite_start]I filtri in `matches_filters` evitano il caricamento di informazioni non di interesse[cite: 989].</p>
            [cite_start]<p>**ğŸ”µ Transform**: I dati estratti vengono elaborati e convertiti in oggetti di tipo `Spectrum`[cite: 990].</p>
            [cite_start]<p>**ğŸ”´ Load**: Il risultato del match (`match_spectra`) viene generato tramite `generate_output` e salvato come file JSON[cite: 991].</p>

            [cite_start]<h4>ğŸ› ï¸ Metodi principali [cite: 992]</h4>
            <ul>
                [cite_start]<li>`matches_filters(item: JSON, filters: str)`: Applica filtri su macchina, `ion_mode` e classe del composto[cite: 993].</li>
                [cite_start]<li>`find_ready_reference(base_dir: path)`: Determina la directory attiva tra `reference_db_a` e `reference_db_b` (strategia **Zero-Downtime A/B**)[cite: 995, 997].</li>
                <li>`match_spectra(...)`: Metodo principale. Calcola la similaritÃ  mediante metodo del **Modified Cosine** in modalitÃ  simmetrica. [cite_start]Estrae i primi `top_n` match[cite: 1005, 1006, 1008].</li>
            </ul>
        </article>
    </div>
</section>


<footer class="footer">
    <div class="cols container">
        <div>
            <div class="brand" style="margin-bottom:.5rem">
                <img src="assets/logo.svg" alt="" width="28" height="28"/>
                <span>B4PhytoWeb</span>
            </div>
            <p class="muted">
                B4Web: una tassonomia Biomolecolare, delle Biofonti e delle BioattivitÃ  per liberare il potenziale della BiodiversitÃ  â€“ finanziato da: 
                Commissione Europea - Next Generation EU, Missione 4 Componente 1 CUP C33C24000340001
            </p>
        </div>

        <div>
            <h3>Sezioni</h3>
            <ul>
                <li><a href="funzionalita.html">FunzionalitÃ </a></li>
                <li><a href="vantaggi.html">Vantaggi</a></li>
                <li><a href="origine.html">Origine</a></li>
                <li><a href="supporto.html">Supporto</a></li>
                <li><a href="lp-video.html">Esplora la piattaforma</a></li>
            </ul>
        </div>

        <div class="footer-logos" style="display:flex;flex-wrap:wrap;gap:1rem;align-items:center;justify-content:flex-start">
            <img src="assets/20240209112418!LOGO_italiadomani.jpg" alt="Italia Domani" height="50" />
            <img src="assets/EN_Funded_by_the_European_Union_RGB_POS.png" alt="Finanziato dall'Unione Europea" height="50" />
            <img src="assets/LOGO_UniversitaRicerca.jpg" alt="Ministero dell'UniversitÃ  e della Ricerca" height="50" />
            <img src="assets/Logo_NBFC.png" alt="NBFC" height="50" />
        </div>
    </div>
</footer>
<script src="assets/script.js"></script>
</body>
</html>
